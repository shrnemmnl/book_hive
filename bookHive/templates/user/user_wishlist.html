{% load static %} {% include 'includes/header.html' %}

<div class="container-fluid py-4">
  <div class="row">
    <!-- Include sidebar -->
    <div class="col-lg-2">{% include 'user/UserProfile/sidebar.html' %}</div>

    <!-- Main Content Column -->
    <div class="col-lg-10 py-5">
      

      <div id="wishlist-container">
        <h2 class="mb-4">My Wishlist</h2>
        <!-- ðŸ‘ˆ add this wrapper -->
        {% for item in wishlist_items %}
        <div class="card mb-3 shadow-lg border-0" style="border-radius: 10px">
          
          <div class="row g-0 align-items-center">
            
            <div class="col-md-2 p-3">
              <img
                src="{{ item.variant.product.image.url }}"
                alt="{{ item.variant.product.book_title }}"
                class="img-fluid rounded shadow-lg"
                style="max-height: 120px; object-fit: cover"
              />
            </div>
            <div class="col-md-7">
              <div class="card-body">
                <h5 class="card-title mb-1">
                  {{ item.variant.product.book_title }}
                </h5>
                <p class="card-text text-muted mb-2">
                  Variant: {{ item.variant.language }} | â‚¹{{ item.variant.price }}
                </p>
                <a
                  href="{% url 'product_details' item.variant.product.id %}"
                  class="btn btn-sm btn-primary"
                  >View Product</a
                >
                <button
                  class="btn btn-sm btn-success ms-2 add-to-cart-btn"
                  data-product-id="{{ item.variant.product.id }}"
                  data-variant-id="{{ item.variant.id }}"
                >Add to Cart</button>
              </div>
            </div>
            <div class="col-md-3 text-end p-3">
              <button class="btn btn-sm btn-outline-danger">
                <i class="bi bi-trash" data-id="{{ item.id }}"></i>
              </button>
            </div>
          </div>
        </div>
      {% empty %}
      <div class="card p-4 text-center border-0 shadow-sm">
        <p class="text-muted mb-0">No items in your wishlist.</p>
      </div>
      {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- delete cart-items -->
<script>
  $(document).ready(function () {
    function refreshEmptyState() {
      if ($("#wishlist-container .card").length === 0) {
        $("#wishlist-container").html(`
          <div class="card p-4 text-center border-0 shadow-sm">
            <p class="text-muted mb-0">No items in your wishlist.</p>
          </div>
        `);
      }
    }
    $(".bi-trash").click(function () {
      const itemId = $(this).data("id");

      $.ajax({
        url: "remove-from-wishlist",
        type: "POST",
        data: {
          item_id: itemId,
          csrfmiddlewaretoken: "{{ csrf_token }}",
        },
        success: function (response) {
          if (response.success) {
            // Remove item card from DOM
            $(`.btn-outline-danger:has([data-id="${itemId}"])`)
              .closest(".card")
              .remove();

            // ðŸ‘‡ if no more cards left, show empty message
            refreshEmptyState();
          } else {
            // error response from backend
            toastr.error("Error: " + response.error);
          }
        },
        error: function () {
          toastr.error("Something went wrong!");
        },
      });
    });

    $(".add-to-cart-btn").click(function () {
      const $btn = $(this);
      const productId = $btn.data("product-id");
      const variantId = $btn.data("variant-id");

      $.ajax({
        url: `/add_to_cart/${productId}/`,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          variant_id: variantId,
          quantity: 1,
          buy_now: false,
        }),
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        success: function (response) {
          if (response.success) {
            // Remove card from DOM (add_to_cart also deletes wishlist entry server-side)
            $btn.closest(".card").remove();

            // If list becomes empty, show empty message
            refreshEmptyState();

            toastr.success("Added to cart");
          } else {
            toastr.error(response.message || "Could not add to cart");
          }
        },
        error: function () {
          toastr.error("Something went wrong!");
        },
      });
    });
  });
</script>

{% include 'includes/footer.html' %}
