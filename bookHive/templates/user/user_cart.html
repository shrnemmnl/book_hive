{% load static %}
{% load price_filters %}
{% include 'includes/header.html' %}

<div class="container-fluid">
  <div class="row">
    <!-- Include sidebar -->
    <div class="col-lg-2">
      {% include 'user/UserProfile/sidebar.html' %}
    </div>

    <!-- Main Content Column -->
    <div class="col-lg-10 py-3">
      <div class="content-wrapper bg-white p-4 shadow-lg rounded">
        <h4 class="mb-4">My Cart</h4>

        <div class="row">
          <!-- Cart Items Column -->
          <div class="{% if cart_item %}col-md-8{% else %}col-12{% endif %} cart-items">
            {% for item in cart_item %}
            <div class="card mb-2 cart-item-card">
              <div class="card-body p-3 shadow-lg">
                <div class="row align-items-center">
                  <div class="col-md-2 col-3">
                    {% with item.product_variant.productimage_set.first as image %}
                    {% if image %}
                    <img src="{{ image.image1.url }}" alt="Book Cover" class="img-fluid cart-item-image" />
                    {% else %}
                    <img src="{% static 'default_image.jpg' %}" alt="No Image" class="img-fluid cart-item-image" />
                    {% endif %}
                    {% endwith %}
                  </div>
                  <div class="col-md-4 col-3">
                    <h5 class="card-title mb-1 cart-item-title">{{ item.product_variant.product.book_title }}</h5>
                    <p class="text-muted mb-0 cart-item-author">by {{ item.product_variant.product.author }}</p>
                    {% if item.product_variant.product.has_active_offer %}
                      <small class="badge bg-warning text-dark">{{ item.product_variant.product.get_best_discount_percentage }}% OFF</small>
                    {% endif %}
                  </div>
                  <div class="col-md-2 col-2 text-center">
                    <div class="quantity-selector d-flex align-items-center justify-content-center">
                      <button class="btn btn-sm btn-outline-secondary btn-decrease cart-btn"
                        data-id="{{ item.id }}">-</button>
                      <input type="text" class="form-control form-control-sm mx-1 text-center quantity cart-input"
                        value="{{ item.quantity }}" style="width: 35px" data-id="{{ item.id }}" readonly />
                      <button class="btn btn-sm btn-outline-secondary btn-increase cart-btn"
                        data-id="{{ item.id }}">+</button>
                    </div>
                  </div>
                  <div class="col-md-2 col-2 text-center">
                    {% if item.product_variant.product.has_active_offer %}
                      <p class="fw-bold mb-0 text-success cart-item-price" id="item-total-{{ item.id }}">
                        â‚¹{{ item.product_variant.price|calculate_discount:item.product_variant.product|floatformat:0 }}
                      </p>
                      <p class="text-muted text-decoration-line-through mb-0" style="font-size: 0.75rem;">
                        â‚¹{{ item.product_variant.price }}
                      </p>
                    {% else %}
                      <p class="fw-bold mb-0 cart-item-price" id="item-total-{{ item.id }}">â‚¹{{ item.get_total_price }}
                      </p>
                    {% endif %}
                  </div>
                  <div class="col-md-2 col-2 text-end">
                    <button class="btn btn-sm btn-outline-danger cart-btn" data-id="{{ item.id }}">
                      <i class="bi bi-trash" data-id="{{ item.id }}"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {% empty %}
            <p>Your cart is empty.</p>
            {% endfor %}
          </div>

          <!-- Cart Summary Column -->
          {% if cart_item %}
          <div class="col-md-4">
            <div class="card cart-summary-card">
              <div class="card-body p-3 shadow-lg">
                <div class="cart-summary">
                  <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span id="cart-subtotal">â‚¹{{ subtotal }}</span>
                  </div>
                  <div class="d-flex justify-content-between mb-2">
                    <span>Shipping:</span>
                    <span>Free</span>
                  </div>
                  <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span id="cart-nettotal">â‚¹{{ subtotal }}</span>
                  </div>
                  <a href="{% url 'checkoutpage' %}" class="btn btn-primary w-100 mt-3 text-decoration-none"
                    id="checkout-button">
                    Proceed to Checkout
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Cart Summary Below on Empty Cart -->
        {% if not cart_item %}
        <div class="card mt-4 cart-summary-card">
          <div class="card-body p-3">
            <div class="cart-summary">
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span id="cart-subtotal">â‚¹{{ subtotal }}</span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Shipping:</span>
                <span>Free</span>
              </div>
              <div class="d-flex justify-content-between fw-bold">
                <span>Total:</span>
                <span id="cart-nettotal">â‚¹{{ subtotal }}</span>
              </div>
              <a href="#" class="btn w-100 mt-3 disabled text-decoration-none" id="checkout-button">Proceed to
                Checkout</a>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    $(".btn-increase, .btn-decrease").click(function () {
      const itemId = $(this).data("id");
      const action = $(this).hasClass("btn-increase") ? "increase" : "decrease";
      const input = $('input.quantity[data-id="' + itemId + '"]');
      let currentQty = parseInt(input.val());

      // ðŸ‘‡ Client-side limit
      if (action === "increase" && currentQty >= 5) {
        toastr.warning("Maximum quantity is 5"); // âœ… toast instead of alert
        return;
      }

      $.ajax({
        url: "update-quantity",
        type: "POST",
        data: {
          item_id: itemId,
          action: action,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.success) {
            input.val(response.new_quantity);
            $('#cart-subtotal').text('â‚¹' + response.cart_total);
            $('#cart-nettotal').text('â‚¹' + response.cart_total);
            $('#item-total-' + itemId).text('â‚¹' + response.item_total_price);


          } else {
            alert("Error: " + response.error);
          }
        },
        error: function () {
          alert("Something went wrong!");
        }
      });
    });
  });


</script>

<!-- delete cart-items -->
<script>
  $(document).ready(function () {
    $(".bi-trash").click(function () {
      const itemId = $(this).data("id");

      $.ajax({
        url: "delete-cart-item",
        type: "POST",
        data: {
          item_id: itemId,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function (response) {
          if (response.success) {
            // Remove item card from DOM
            $(`.btn-outline-danger:has([data-id="${itemId}"])`).closest(".card").remove();

            // Update cart total
            $('#cart-subtotal').text('â‚¹' + response.cart_total);
            $('#cart-nettotal').text('â‚¹' + response.cart_total);

            // ðŸ§  Update checkout button based on item count
            if (response.count > 0) {
              $('#checkout-button')
                .removeClass('disabled')
                .addClass('btn-primary')
                .attr('href', '{% url "checkoutpage" %}');
            } else {
              $('#checkout-button')
                .addClass('disabled')
                .removeClass('btn-primary')
                .attr('href', '#');

            }
          }
          else {
            alert("Error: " + response.error);
          }
        },
        error: function () {
          alert("Something went wrong!");
        }
      });
    });
  });
</script>


{% include 'includes/footer.html' %}