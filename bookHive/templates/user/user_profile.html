{% load static %} 
{% include 'includes/header.html' %}

<div class="container-fluid">
  <div class="row">
    <!-- Include sidebar -->
    <div class="col-lg-3">{% include 'user/UserProfile/sidebar.html' %}</div>

    <!-- Main Content Column -->
    <div class="col-lg-9 py-3">
      {% comment %}
      <div>{% include "message.html" %}</div>
      {% endcomment %}
      <div class="content-wrapper bg-white p-4 shadow-lg rounded">
        <h4 class="mb-4">Personal Information</h4>
        <form method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="personal_info" />
          <div class="row mb-3">
            <div class="mb-3 mb-md-0">
              <div class="user-avatar mb-4 text-center">
                <label for="profilePicInput" style="cursor: pointer">
                  <img
                    src="{{ user.profile_pic.url }}"
                    alt="User Avatar"
                    class="rounded-circle shadow"
                    width="100"
                    height="100"
                    style="object-fit: cover"
                  />
                </label>
                <input
                  type="file"
                  id="profilePicInput"
                  name="profile_pic"
                  accept="image/*"
                  class="d-none {% if error.valid_image %}is-invalid{% endif %}"
                />
                <p class="small text-muted mt-1">Click image to change</p>
                {% if error.valid_image %}
                <div class="text-danger mt-1">{{ error.valid_image }}</div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="firstName" class="form-label">First Name</label>
            <input
              type="text"
              class="form-control {% if error.fname_pattern or error.pattern_length %}is-invalid{% endif %}"
              id="firstName"
              name="firstName"
              value="{{user.first_name}}"
            />

            {% if error.fname_pattern %}
            <div class="text-danger mt-1">{{ error.fname_pattern }}</div>
            {% elif error.pattern_length %}
            <div class="text-danger mt-1">{{ error.pattern_length }}</div>
            {% endif %}
            <label for="lastName" class="form-label">Last Name</label>
            <input
              type="text"
              class="form-control {% if error.empty_lname or error.lname_pattern %}is-invalid{% endif %}"
              id="lastName"
              name="lastName"
              value="{{user.last_name}}"
            />

            {% if error.lname_pattern %}
            <div class="text-danger mt-1">{{ error.lname_pattern }}</div>

            {% endif %}
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input
              type="email"
              class="form-control"
              id="email"
              name="email"
              readonly
              value="{{user.email}}"
            />
          </div>

          <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input
              type="tel"
              class="form-control {% if error.mobile_pattern %}is-invalid{% endif %}"
              id="phone"
              name="phone_no"
              value="{{user.phone_no}}"
            />
            {% if error.mobile_pattern %}
            <div class="text-danger mt-1">{{ error.mobile_pattern }}</div>
            {% endif %}
          </div>
          
          <!-- Referral Code Section -->
          <div class="mb-3 p-3 bg-light rounded border">
            <label class="form-label fw-bold"><i class="bi bi-gift-fill text-success me-2"></i>Your Referral Code</label>
            <div class="input-group">
              <input
                type="text"
                class="form-control form-control-lg fw-bold text-primary"
                id="referralCode"
                value="{{ user.referral_code }}"
                readonly
                style="letter-spacing: 2px; font-size: 1.2rem;"
              />
              <button class="btn btn-outline-primary" type="button" onclick="copyReferralCode()">
                <i class="bi bi-clipboard"></i> Copy
              </button>
            </div>
            <small class="text-muted mt-2 d-block">
              <i class="bi bi-info-circle me-1"></i>
              Share this code with friends! When they sign up using your code, you'll receive a â‚¹300 coupon as a reward.
            </small>
          </div>
          
          <div class="d-flex gap-3 align-items-center">
            <div>
              <button type="submit" class="btn btn-success">
                Save Changes
              </button>
            </div>
            <div>
              <a href="{% url 'profile_email_change' %}">Change Email</a>
            </div>
            <div>
              <a href="{% url 'profile_password_change' %}">Change Password</a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% include 'includes/footer.html' %}

<script>
function copyReferralCode() {
  const referralCodeInput = document.getElementById('referralCode');
  referralCodeInput.select();
  referralCodeInput.setSelectionRange(0, 99999); // For mobile devices
  
  navigator.clipboard.writeText(referralCodeInput.value).then(function() {
    // Show success feedback
    const btn = event.target.closest('button');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check-lg"></i> Copied!';
    btn.classList.remove('btn-outline-primary');
    btn.classList.add('btn-success');
    
    setTimeout(function() {
      btn.innerHTML = originalHTML;
      btn.classList.remove('btn-success');
      btn.classList.add('btn-outline-primary');
    }, 2000);
  }).catch(function(err) {
    console.error('Failed to copy: ', err);
    alert('Failed to copy referral code');
  });
}
</script>
