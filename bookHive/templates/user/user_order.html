{% load static %}
{% load price_filters %}
{% include 'includes/header.html' %}

<style>
  .orders-page {
    background: #f8fafc;
    min-height: calc(100vh - 200px);
    padding: 2rem 0;
  }
  
  .orders-header {
    background: linear-gradient(135deg, #4a00e0, #8e2de2);
    color: white;
    padding: 1.5rem;
    border-radius: 12px 12px 0 0;
    margin-bottom: 0;
  }
  
  .orders-content {
    background: white;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    padding: 1.5rem;
  }
  
  .search-filters {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 1px solid #e2e8f0;
  }
  
  .form-control, .form-select {
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #4a00e0;
    box-shadow: 0 0 0 3px rgba(74, 0, 224, 0.1);
  }
  
  .order-card {
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }
  
  .order-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }
  
  .order-card-header {
    background: #f8fafc;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .order-item {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
  }
  
  .order-item:last-child {
    border-bottom: none;
  }
  
  .order-item-image {
    width: 100%;
    height: 100px;
    object-fit: cover;
    border-radius: 8px;
  }
  
  .status-badge {
    font-size: 0.75rem;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    font-weight: 600;
  }
  
  .order-card-footer {
    background: #f8fafc;
    padding: 1rem 1.5rem;
    border-top: 1px solid #e2e8f0;
  }
  
  .btn-sm {
    border-radius: 6px;
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
    font-weight: 500;
  }
  
  .empty-orders {
    text-align: center;
    padding: 4rem 2rem;
  }
  
  .empty-orders-icon {
    font-size: 4rem;
    color: #cbd5e1;
    margin-bottom: 1rem;
  }
</style>

<div class="orders-page">
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 d-none d-lg-block">
        {% include 'user/UserProfile/sidebar.html' %}
      </div>

      <!-- Main Content -->
      <div class="col-lg-10">
        <div class="orders-header">
          <h4 class="mb-0 d-flex align-items-center">
            <i class="bi bi-bag-check me-2"></i>My Orders
          </h4>
          <p class="mb-0 mt-1" style="opacity: 0.9; font-size: 0.9rem;">Track and manage your orders</p>
        </div>
        
        <div class="orders-content">
          <!-- Search and Filters -->
          <div class="search-filters">
            <form method="GET" action="{% url 'order_search' %}" class="row g-3">
              <div class="col-md-4">
                <input type="text" name="search" class="form-control" placeholder="Search by Order ID" 
                       value="{{ request.GET.search|default:'' }}" />
              </div>
              <div class="col-md-3">
                <select name="period" class="form-select">
                  <option value="all" {% if request.GET.period == 'all' or not request.GET.period %}selected{% endif %}>All Orders</option>
                  <option value="30days" {% if request.GET.period == '30days' %}selected{% endif %}>Past 30 Days</option>
                  <option value="3months" {% if request.GET.period == '3months' %}selected{% endif %}>Past 3 Months</option>
                  <option value="6months" {% if request.GET.period == '6months' %}selected{% endif %}>Past 6 Months</option>
                  <option value="2025" {% if request.GET.period == '2025' %}selected{% endif %}>2025</option>
                  <option value="2024" {% if request.GET.period == '2024' %}selected{% endif %}>2024</option>
                </select>
              </div>
              <div class="col-md-3">
                <select name="status" class="form-select">
                  <option value="" {% if not request.GET.status %}selected{% endif %}>All Statuses</option>
                  <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                  <option value="shipped" {% if request.GET.status == 'shipped' %}selected{% endif %}>Shipped</option>
                  <option value="delivered" {% if request.GET.status == 'delivered' %}selected{% endif %}>Delivered</option>
                  <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                  <option value="request to cancel" {% if request.GET.status == 'request to cancel' %}selected{% endif %}>Request to Cancel</option>
                  <option value="request to return" {% if request.GET.status == 'request to return' %}selected{% endif %}>Request to Return</option>
                  <option value="return approved" {% if request.GET.status == 'return approved' %}selected{% endif %}>Returned</option>
                </select>
              </div>
              <div class="col-md-2">
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary flex-fill" style="border-radius: 8px;">
                    <i class="bi bi-search me-1"></i>Search
                  </button>
                  <a href="{% url 'order_search' %}" class="btn btn-outline-secondary" style="border-radius: 8px;" title="Clear filters">
                    <i class="bi bi-x-lg"></i>
                  </a>
                </div>
              </div>
            </form>
            {% if period_filter %}
            <div class="mt-3">
              <p class="mb-0 text-muted" style="font-size: 0.9rem;">
                <strong>{{ order_count }}</strong> order{{ order_count|pluralize }} placed
                {% if period_filter == 'all' %}
                  since started
                {% else %}
                  in
                  {% if period_filter == '30days' %}the past 30 days{% endif %}
                  {% if period_filter == '3months' %}the past 3 months{% endif %}
                  {% if period_filter == '6months' %}the past 6 months{% endif %}
                  {% if period_filter == '2025' %}2025{% endif %}
                  {% if period_filter == '2024' %}2024{% endif %}
                {% endif %}
              </p>
            </div>
            {% endif %}
          </div>

          <!-- Orders List -->
          <div class="order-list">
            {% for order in order_details %}
            <div class="order-card">
              <div class="order-card-header">
                <div class="row align-items-center">
                  <div class="col-md-4">
                    <p class="mb-0 fw-semibold" style="color: #1e293b;">
                      <i class="bi bi-receipt me-2 text-primary"></i>Order ID: {{ order.order_id }}
                    </p>
                  </div>
                  <div class="col-md-4">
                    <p class="mb-0 text-muted" style="font-size: 0.9rem;">
                      <i class="bi bi-calendar me-1"></i>{{ order.created_at|date:"d M Y" }}
                    </p>
                  </div>
                  <div class="col-md-4 text-md-end">
                    <p class="mb-0 fw-bold" style="color: #1e293b; font-size: 1.1rem;">
                      ₹{{ order.net_amount|floatformat:2 }}
                    </p>
                    {% if order.coupon_discount and order.coupon_discount > 0 %}
                      <span class="badge bg-success" style="font-size: 0.7rem;">
                        <i class="bi bi-tag-fill me-1"></i>{{ order.coupon_code }}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <div class="card-body p-0">
                {% for item in order.order_items.all %}
                <div class="order-item">
                  <div class="row align-items-center">
                    <div class="col-md-2 col-3">
                      {% with item.product_variant.productimage_set.first as image %}
                        {% if image %}
                          <img src="{{ image.image1.url }}" alt="Book Cover" class="order-item-image" />
                        {% else %}
                          <img src="{% static 'default_image.jpg' %}" alt="No Image" class="order-item-image" />
                        {% endif %}
                      {% endwith %}
                    </div>
                    <div class="col-md-5 col-6">
                      <h6 class="mb-1 fw-semibold" style="color: #1e293b; font-size: 0.95rem;">
                        {{ item.product_variant.product.book_title }}
                      </h6>
                      <p class="text-muted mb-1" style="font-size: 0.85rem;">{{ item.product_variant.product.author }}</p>
                      <p class="mb-1" style="font-size: 0.85rem; color: #64748b;">Quantity: {{ item.quantity }}</p>
                      <span class="status-badge bg-{% if item.status == 'delivered' %}success{% elif item.status == 'request to cancel' %}dark{% elif item.status == 'request to return' %}dark{% elif item.status == 'cancelled' %}danger{% elif item.status == 'shipped' %}info{% elif item.status == 'return approved' %}primary{% else %}warning{% endif %} text-white">
                        {% if item.status == 'return approved' %}Returned{% else %}{{ item.status|capfirst }}{% endif %}
                      </span>
                      {% if item.is_refunded %}
                      <br><span class="badge bg-success mt-1" style="font-size: 0.7rem;">
                        <i class="bi bi-check-circle me-1"></i>Refunded to Wallet
                      </span>
                      {% endif %}
                    </div>
                    <div class="col-md-3 col-6 text-end">
                      {% if item.discount_price < item.unit_price %}
                        <div class="fw-bold text-success mb-0" style="font-size: 1rem;">₹{{ item.total_amount|floatformat:0 }}</div>
                        <div class="text-muted text-decoration-line-through" style="font-size: 0.75rem;">₹{{ item.original_total_price|floatformat:0 }}</div>
                      {% else %}
                        <p class="mb-0 fw-semibold" style="font-size: 1rem; color: #1e293b;">₹{{ item.total_amount|floatformat:0 }}</p>
                      {% endif %}
                    </div>
                    <div class="col-md-2 col-12 text-end mt-2 mt-md-0">
                      {% if item.status not in 'request to cancel,cancelled,return approved,request to return' %}
                      <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#cancelOrderModal{{ item.id }}">
                        {% if item.status == 'delivered' %}Return{% else %}Cancel{% endif %}
                      </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              
              <div class="order-card-footer d-flex justify-content-between align-items-center">
                <div></div>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#viewDetailsModal{{ order.id }}">
                    <i class="bi bi-eye me-1"></i>View Details
                  </button>
                  <a href="{% url 'download_invoice' order.id %}" class="btn btn-sm btn-outline-success" data-no-transition>
                    <i class="bi bi-file-earmark-pdf me-1"></i>Invoice
                  </a>
                </div>
              </div>
            </div>

            <!-- View Details Modal -->
            <div class="modal fade" id="viewDetailsModal{{ order.id }}" tabindex="-1" aria-labelledby="viewDetailsModalLabel{{ order.id }}" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content" style="border-radius: 12px; border: none;">
                  <div class="modal-header" style="background: linear-gradient(135deg, #4a00e0, #8e2de2); color: white; border-radius: 12px 12px 0 0;">
                    <h5 class="modal-title" id="viewDetailsModalLabel{{ order.id }}">Order Details - {{ order.order_id }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body p-4">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <p class="mb-2"><strong>Order ID:</strong> {{ order.order_id }}</p>
                        <p class="mb-2"><strong>Placed On:</strong> {{ order.created_at|date:"d M Y, h:i A" }}</p>
                        <p class="mb-0"><strong>Payment Method:</strong> 
                          {% if order.payment_method == 'razorpay' %}
                            <span class="badge bg-primary">Razorpay</span>
                          {% elif order.payment_method == 'wallet' %}
                            <span class="badge bg-info">Wallet</span>
                          {% elif order.payment_method == 'cod' %}
                            <span class="badge bg-warning text-dark">Cash on Delivery</span>
                          {% else %}
                            <span class="badge bg-secondary">{{ order.payment_method|default:"Cash on Delivery" }}</span>
                          {% endif %}
                        </p>
                      </div>
                      <div class="col-md-6 text-md-end">
                        <p class="mb-2"><strong>Total Amount:</strong> <span class="fw-bold" style="font-size: 1.2rem;">₹{{ order.net_amount }}</span></p>
                        <p class="mb-0"><strong>Payment Status:</strong> 
                          {% if order.is_paid %}
                            <span class="badge bg-success">Paid</span>
                          {% else %}
                            <span class="badge bg-warning text-dark">Pending</span>
                          {% endif %}
                        </p>
                      </div>
                    </div>
                    <hr>
                    <h6 class="fw-bold mb-3">Items Ordered</h6>
                    {% for item in order.order_items.all %}
                    <div class="row align-items-center mb-3 p-3" style="background: #f8fafc; border-radius: 8px;">
                      <div class="col-md-2">
                        <img src="{{ item.product_variant.productimage_set.first.image1.url }}" alt="{{ item.product_variant.product.book_title }}" 
                             class="img-fluid rounded" style="max-height: 60px; width: 100%; object-fit: cover;" />
                      </div>
                      <div class="col-md-5">
                        <p class="mb-1 fw-semibold">{{ item.product_variant.product.book_title }}</p>
                        <p class="text-muted mb-1" style="font-size: 0.9rem;">{{ item.product_variant.product.author }}</p>
                        <p class="small mb-1">Quantity: {{ item.quantity }}</p>
                        <span class="status-badge bg-{% if item.status == 'delivered' %}success{% elif item.status == 'request to cancel' %}dark{% elif item.status == 'request to return' %}dark{% elif item.status == 'cancelled' %}danger{% elif item.status == 'shipped' %}info{% elif item.status == 'return approved' %}primary{% else %}warning{% endif %} text-white">
                          {% if item.status == 'return approved' %}Returned{% else %}{{ item.status|capfirst }}{% endif %}
                        </span>
                        {% if item.is_refunded %}
                        <br><span class="badge bg-success mt-1" style="font-size: 0.7rem;">
                          <i class="bi bi-check-circle me-1"></i>Refunded to Wallet
                        </span>
                        {% endif %}
                      </div>
                      <div class="col-md-5 text-md-end">
                        {% if item.discount_price < item.unit_price %}
                          <div class="fw-bold text-success mb-0" style="font-size: 1.1rem;">₹{{ item.total_amount|floatformat:0 }}</div>
                          <div class="text-muted text-decoration-line-through" style="font-size: 0.85rem;">₹{{ item.original_total_price|floatformat:0 }}</div>
                        {% else %}
                          <p class="mb-0 fw-semibold" style="font-size: 1.1rem; color: #1e293b;">₹{{ item.total_amount|floatformat:2 }}</p>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                    <hr>
                    <div class="row">
                      <div class="col-md-6">
                        <h6 class="fw-bold mb-2">Shipping Address</h6>
                        {% if order.address %}
                          <p class="mb-1"><strong>{{ order.address.address_type|title }}</strong></p>
                          <p class="mb-1" style="font-size: 0.9rem;">{{ order.address.street }}</p>
                          {% if order.address.landmark %}
                          <p class="mb-1" style="font-size: 0.9rem;">{{ order.address.landmark }}</p>
                          {% endif %}
                          <p class="mb-1" style="font-size: 0.9rem;">{{ order.address.city }}, {{ order.address.state }} {{ order.address.postal_code }}</p>
                          <p class="mb-0" style="font-size: 0.9rem;"><i class="bi bi-telephone me-1"></i>{{ order.address.phone }}</p>
                        {% else %}
                          <p class="text-muted">No address available</p>
                        {% endif %}
                      </div>
                      <div class="col-md-6 text-md-end">
                        {% if order.original_subtotal > order.subtotal %}
                        <p class="mb-1"><strong>Total MRP:</strong> <span class="text-muted text-decoration-line-through">₹{{ order.original_subtotal|floatformat:0 }}</span></p>
                        <p class="mb-1 text-success"><strong>Discount:</strong> -₹{{ order.total_discount_from_offers|floatformat:0 }}</p>
                        {% endif %}
                        <p class="mb-1"><strong>Subtotal:</strong> ₹{{ order.subtotal|floatformat:2 }}</p>
                        {% if order.coupon_discount and order.coupon_discount > 0 %}
                        <p class="mb-1 text-success"><strong>Coupon Discount ({{ order.coupon_code }}):</strong> -₹{{ order.coupon_discount|floatformat:2 }}</p>
                        {% endif %}
                        <p class="mb-1"><strong>Shipping:</strong> Free</p>
                        <p class="fw-bold text-primary mb-0" style="font-size: 1.2rem;"><strong>Total:</strong> ₹{{ order.net_amount|floatformat:2 }}</p>
                        {% if order.original_subtotal > order.subtotal or order.coupon_discount %}
                        <div class="text-center mt-2">
                          <small class="text-success">
                            <i class="bi bi-tag-fill me-1"></i>You saved ₹{{ order.total_discount_from_offers|add:order.coupon_discount|default:0|floatformat:2 }} in total!
                          </small>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer" style="border-top: 1px solid #e2e8f0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">Close</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cancel Order Item Modal -->
            {% for item in order.order_items.all %}
            {% if item.status not in 'request to cancel,cancelled,return approved,request to return' %}
            <div class="modal fade" id="cancelOrderModal{{ item.id }}" tabindex="-1" aria-labelledby="cancelOrderModalLabel{{ item.id }}" aria-hidden="true">
              <div class="modal-dialog">
                <form method="POST" action="{% url 'cancel_order' item.id %}">
                  {% csrf_token %}
                  <div class="modal-content" style="border-radius: 12px; border: none;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #4a00e0, #8e2de2); color: white; border-radius: 12px 12px 0 0;">
                      <h5 class="modal-title" id="cancelOrderModalLabel{{ item.id }}">
                        {% if item.status == 'delivered' %}Return Request{% else %}Cancel Order Item{% endif %} - {{ order.order_id }}
                      </h5>
                      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                      <p class="mb-2"><strong>Item:</strong> {{ item.product_variant.product.book_title }}</p>
                      <div class="mb-3">
                        <label for="cancelReason{{ item.id }}" class="form-label">Reason for {% if item.status == 'delivered' %}Return{% else %}cancellation:{% endif %}</label>
                        <textarea class="form-control" id="cancelReason{{ item.id }}" name="reason" rows="3" required 
                                  style="border-radius: 8px; border: 1.5px solid #e2e8f0;"></textarea>
                      </div>
                    </div>
                    <div class="modal-footer" style="border-top: 1px solid #e2e8f0;">
                      <button type="submit" class="btn btn-danger" style="border-radius: 8px;">
                        <i class="bi bi-check-circle me-2"></i>Submit
                      </button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">Close</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
            {% endif %}
            {% endfor %}
            
            {% empty %}
            <div class="empty-orders">
              <div class="empty-orders-icon">
                <i class="bi bi-bag-x"></i>
              </div>
              <h5 class="mb-2" style="color: #1e293b;">No orders found</h5>
              <p class="text-muted mb-4">You haven't placed any orders yet.</p>
              <a href="{% url 'loading_page' %}" class="btn btn-primary" style="border-radius: 8px;">
                <i class="bi bi-arrow-left me-2"></i>Start Shopping
              </a>
            </div>
            {% endfor %}
          </div>

          <!-- Pagination -->
          {% if order_details.has_other_pages %}
          <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Page navigation">
              <ul class="pagination pagination-sm mb-0">
                {% if order_details.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ order_details.previous_page_number }}" style="border-radius: 6px; margin: 0 2px; border: 1px solid #e2e8f0;">
                    <i class="bi bi-chevron-left"></i>
                  </a>
                </li>
                {% endif %}
                {% for i in order_details.paginator.page_range %}
                <li class="page-item{% if order_details.number == i %} active{% endif %}">
                  <a class="page-link" href="?page={{ i }}" style="border-radius: 6px; margin: 0 2px; border: 1px solid #e2e8f0; color: #64748b;">
                    {{ i }}
                  </a>
                </li>
                {% endfor %}
                {% if order_details.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ order_details.next_page_number }}" style="border-radius: 6px; margin: 0 2px; border: 1px solid #e2e8f0;">
                    <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
                {% endif %}
              </ul>
            </nav>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'includes/footer.html' %}
