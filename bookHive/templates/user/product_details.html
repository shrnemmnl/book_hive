{% extends "base.html" %}

{% load custom_filters %}
{% load price_filters %}
{% load static %}

{% block page_content %}
<div class="container-fluid px-3 py-3">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb" style="font-size: 0.85rem;">
      <li class="breadcrumb-item">
        <a href="{% url 'loading_page' %}">Home</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Product Details</li>
    </ol>
  </nav>

  <!-- Hidden input for book ID -->
  <input type="hidden" id="book-id" data-book-id="{{ book.id }}" value="{{ book.id }}">

  <div class="row g-3">
    <!-- Book Cover and Variant Images -->
    <div class="col-md-4 mb-3">
      <!-- Main large image with zoom container -->
      <div class="position-relative mb-3 rounded shadow-lg" id="imageContainer" style="overflow: hidden;">
        <img id="mainImage" src="{{ default_variant.productimage_set.first.image1.url }}" alt="{{ book.book_title }}"
          class="img-fluid rounded w-100" style="max-height: 400px; object-fit: contain;">
        <div id="zoomedImage"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-repeat: no-repeat; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;">
        </div>
      </div>

      <!-- Thumbnail images row -->
      <div class="row g-2 rounded shadow-lg">
        {% with images=default_variant.productimage_set.first %}
        <div class="col-4">
          <img src="{{ images.image1.url }}" alt="Image 1" class="img-fluid rounded thumbnail border"
            onclick="changeImage('{{ images.image1.url }}')" style="cursor: pointer; max-height: 80px;">
        </div>
        <div class="col-4">
          <img src="{{ images.image2.url }}" alt="Image 2" class="img-fluid rounded thumbnail"
            onclick="changeImage('{{ images.image2.url }}')" style="cursor: pointer; max-height: 80px;">
        </div>
        <div class="col-4">
          <img src="{{ images.image3.url }}" alt="Image 3" class="img-fluid rounded thumbnail"
            onclick="changeImage('{{ images.image3.url }}')" style="cursor: pointer; max-height: 80px;">
        </div>
        {% endwith %}
      </div>
    </div>

    <!-- Book Details -->
    <div class="col-md-8">
      <h1 class="fw-bold mb-2" style="font-size: 1.75rem;">{{ book.book_title }}</h1>
      <p class="text-muted mb-2" style="font-size: 0.9rem;">By: {{ book.author }}</p>
      <div class="d-flex align-items-center mb-3">
        <!-- Star rating -->
        {% if average_rating_int %}
        <div class="d-flex align-items-center">
          {% for i in '12345' %}
          <i class="bi {% if forloop.counter <= average_rating_int %}bi-star-fill{% else %}bi-star{% endif %} text-warning me-1" style="font-size: 0.9rem;"></i>
          {% endfor %}
          <span class="text-muted ms-2" style="font-size: 0.85rem;">Based on {{ review_count }} reviews</span>
        </div>
        {% else %}
        <div class="text-muted" style="font-size: 0.85rem;">Not Reviewed Yet</div>
        {% endif %}
      </div>

      <!-- Variant Selector -->
      <div class="mb-3 rounded">
        <label for="variantSelector" class="form-label fw-bold" style="font-size: 0.9rem;">Select Language:</label>
        <select id="variantSelector" class="form-select shadow-lg" onchange="changeVariant(this.value)" style="font-size: 0.85rem;">
          {% for variant in variants %}
          <option value="{{ variant.id }}" {% if variant.id == default_variant.id %} selected {% endif %}>
            {{ variant.publisher }} Edition - {{ variant.language }}
          </option>
          {% endfor %}
        </select>
      </div>

      <!-- Variant Price -->
      <div class="mb-3">
        <h3 id="variantPriceBlock" class="fw-bold" style="font-size: 1.25rem;">
          {% if book.has_active_offer %}
          <span style="text-decoration: line-through;">‚Çπ{{ default_variant.price }}</span>
          <strong style="color: green;">‚Çπ{{ default_variant.price|calculate_discount:book }}</strong>
          <span style="color: red;">({{ book.get_best_discount_percentage }}% OFF)</span>
          {% if book.get_active_offer_title %}
            <span class="badge bg-warning text-dark ms-2" style="font-size: 0.75rem;">{{ book.get_active_offer_title }}</span>
          {% endif %}
          {% else %}
          <span>‚Çπ{{ default_variant.price }}</span>
          {% endif %}
        </h3>
        <p id="variantPublisher" class="text-muted" style="font-size: 0.85rem;">Publisher: {{ default_variant.publisher }}</p>
      </div>

      <!-- Stock Status -->
      <div class="mb-3">
        <p id="stockStatus" class="{% if default_variant.available_quantity > 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 0.9rem;">
          {% if default_variant.available_quantity > 0 %}
          ‚úì In Stock ({{ default_variant.available_quantity }} available)
          {% else %}
          Out of Stock
          {% endif %}
        </p>

        {% if default_variant.available_quantity > 0 %}
        <div class="input-group mb-3 shadow-lg" style="max-width: 150px;">
          <button class="btn btn-outline-secondary" type="button" id="decreaseQty" style="font-size: 0.85rem;">-</button>
          <input type="number" id="quantity" class="form-control text-center" value="1" min="1" max="{{ default_variant.available_quantity }}" readonly style="font-size: 0.85rem;">
          <button class="btn btn-outline-secondary" type="button" id="increaseQty" style="font-size: 0.85rem;">+</button>
        </div>
        {% endif %}
      </div>

      <!-- Action Buttons -->
      <div class="d-flex gap-2 mb-3">
        <button class="btn btn-primary flex-fill add-to-cart-btn shadow-lg {% if not is_sold_out %}disabled{% endif %}" 
                data-book-id="{{ book.id }}" type="button" style="font-size: 0.9rem;">
          Add to Cart
        </button>
        <button class="btn btn-danger flex-fill buy-now-btn shadow-lg {% if not is_sold_out %}disabled{% endif %}" 
                data-book-id="{{ book.id }}" type="button" style="font-size: 0.9rem;">
          Buy Now
        </button>
        <button class="btn btn-outline-secondary wishlist-toggle-btn shadow-lg" data-product-id="{{ book.id }}" style="font-size: 0.9rem;">
          {% if variant in user_wishlist_variants %}
          üíî
          {% else %}
          ‚ù§Ô∏è
          {% endif %}
        </button>
      </div>

      <!-- Toast Message Area -->
      <div id="wishlist-toast" class="alert d-none mt-2" role="alert" style="font-size: 0.85rem;"></div>

      <!-- Book Specifications -->
      <div class="row g-3 mt-2" >
        <div class="col-md-5 mx-auto rounded shadow-lg" >
          <table class="table table-borderless" style="font-size: 0.85rem;" >
            <tbody>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Book:</th>
                <td style="background-color: rgba(255, 239, 218, 1);">{{ book.book_title }}</td>
              </tr>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Author:</th>
                <td style="background-color: rgba(255, 239, 218, 1);"><a href="#" class="text-primary">{{ book.author }}</a></td>
              </tr>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Category:</th>
                <td style="background-color: rgba(255, 239, 218, 1);">{{ book.genre.genre_name }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-6 mx-auto rounded shadow-lg">
          <table class="table table-borderless" style="font-size: 0.85rem;">
            <tbody>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Publishing Date:</th>
                <td id="variantDate" style="background-color: rgba(255, 239, 218, 1);">{{ default_variant.published_date }}</td>
              </tr>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Publisher:</th>
                <td id="variantPublisherLink" style="background-color: rgba(255, 239, 218, 1);"><a href="#" class="text-primary">{{ default_variant.publisher }}</a></td>
              </tr>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Edition:</th>
                <td style="background-color: rgba(255, 239, 218, 1);">1</td>
              </tr>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Number of pages:</th>
                <td id="variantPages" style="background-color: rgba(255, 239, 218, 1);">{{ default_variant.page }}</td>
              </tr>
              <tr>
                <th scope="row" class="fw-bold" style="background-color: rgba(255, 239, 218, 1);">Language:</th>
                <td id="variantLanguage" style="background-color: rgba(255, 239, 218, 1);">{{ default_variant.language }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Book Summary -->
  <div class="row mt-4">
    <div class="col-12 rounded shadow-lg">
      <h2 class="fw-bold border-bottom pb-2 mb-3" style="font-size: 1.5rem;">BOOK SUMMARY</h2>
      <p class="lead" style="font-size: 0.9rem;">{{ book.description }}</p>
    </div>
  </div>

  <!-- Hidden CSRF token -->
  <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

  <!-- Book Reviews Section -->
  <div class="row mt-4">
    <div class="col-12">
      <h2 class="fw-bold border-bottom pb-2 mb-3" style="font-size: 1.5rem;">CUSTOMER REVIEWS</h2>
    </div>
  </div>

  <div class="row g-3">
    <!-- Overall Rating Panel (Left Side) -->
    <div class="col-md-4 mb-3">
      <div class="card rounded shadow-lg">
        <div class="card-body">
          <h3 class="card-title fw-bold" style="font-size: 1.25rem;">Overall Rating</h3>
          <div class="d-flex align-items-center mb-3">
            {% if average_rating_int %}
            <div class="display-4 me-3" style="font-size: 2rem;">{{ average_rating|floatformat:1 }}</div>
            <div>
              {% for i in '12345' %}
              <i class="bi {% if forloop.counter <= average_rating_int %}bi-star-fill{% else %}bi-star{% endif %} text-warning me-1" style="font-size: 0.9rem;"></i>
              {% endfor %}
              <div class="text-muted" style="font-size: 0.85rem;">Based on {{ review_count }} reviews</div>
            </div>
            {% else %}
            <div class="text-muted" style="font-size: 0.85rem;">No users attempted the review</div>
            {% endif %}
          </div>

          <!-- Write Review Button -->
          {% if user.is_authenticated %}
          <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#writeReviewModal" style="font-size: 0.9rem;">
            Write a Review
          </button>
          {% else %}
          <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary w-100" style="font-size: 0.9rem;">
            Write a Review
          </a>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Customer Reviews List (Right Side) -->
    <div class="col-md-8">
      <!-- Individual Reviews -->
      {% for review in review_content %}
      {% if review.is_active %}
      <div class="card mb-3 rounded shadow-lg">
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <div class="text-warning">
              {% for s in 5|times %}
              <i class="bi {% if s <= review.rating %}bi-star-fill{% else %}bi-star{% endif %} me-1" style="font-size: 0.9rem;"></i>
              {% endfor %}
            </div>
            <div class="text-muted" style="font-size: 0.8rem;">{{ review.created_at }}</div>
          </div>
          <h6 class="card-subtitle mb-2 text-muted" style="font-size: 0.85rem;">{{ review.user.first_name }}</h6>
          <p class="card-text" style="font-size: 0.85rem;">{{ review.comments }}</p>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- Related Books -->
  <div class="mt-4">
    <h3 class="fw-bold mb-3" style="font-size: 1.25rem;">More from this Genre üìö</h3>
    <div class="related-books d-flex flex-wrap gap-3">
      {% for book in related_books %}
      <div class="book-card bg-white rounded rounded shadow-lg p-2" style="width: 180px;">
        <a href="{% url 'product_details' book.id %}">
          <img src="{{ book.image.url }}" alt="{{ book.book_title }}" class="img-fluid rounded" style="width: 100%; height: 200px; object-fit: cover;">
          <h4 class="fw-bold mt-2" style="font-size: 0.9rem;">{{ book.book_title }}</h4>
          <p class="text-muted" style="font-size: 0.8rem;">by {{ book.author }}</p>
          {% if book.has_active_offer %}
          <span class="badge bg-warning text-dark" style="font-size: 0.75rem;">{{ book.get_best_discount_percentage }}% OFF</span>
          {% endif %} 
        </a>
      </div>
      {% empty %}
      <p class="text-muted" style="font-size: 0.85rem;">No similar books found in this genre.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Write Review Modal -->
  <div class="modal fade" id="writeReviewModal" tabindex="-1" aria-labelledby="writeReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold" id="writeReviewModalLabel" style="font-size: 1.25rem;">Write a Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form method="POST">
            {% csrf_token %}
            <div class="mb-3">
              <h6 class="card-subtitle mb-2 text-muted" style="font-size: 0.85rem;">User: {{ request.user.first_name }}</h6>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold" style="font-size: 0.9rem;">Overall Rating</label>
              <div class="rating-stars mb-2">
                <div class="btn-group" role="group">
                  <input type="radio" class="btn-check" name="overallRating" id="rating1" value="1" autocomplete="off">
                  <label class="btn btn-outline-warning" for="rating1" style="font-size: 0.85rem;">1‚òÖ</label>
                  <input type="radio" class="btn-check" name="overallRating" id="rating2" value="2" autocomplete="off">
                  <label class="btn btn-outline-warning" for="rating2" style="font-size: 0.85rem;">2‚òÖ</label>
                  <input type="radio" class="btn-check" name="overallRating" id="rating3" value="3" autocomplete="off">
                  <label class="btn btn-outline-warning" for="rating3" style="font-size: 0.85rem;">3‚òÖ</label>
                  <input type="radio" class="btn-check" name="overallRating" id="rating4" value="4" autocomplete="off">
                  <label class="btn btn-outline-warning" for="rating4" style="font-size: 0.85rem;">4‚òÖ</label>
                  <input type="radio" class="btn-check" name="overallRating" id="rating5" value="5" autocomplete="off" checked>
                  <label class="btn btn-outline-warning" for="rating5" style="font-size: 0.85rem;">5‚òÖ</label>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="reviewText" class="form-label fw-bold" style="font-size: 0.9rem;">Your Review</label>
              <textarea class="form-control" name="comment" id="reviewText" rows="5" placeholder="What did you like or dislike?" style="font-size: 0.85rem;"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="font-size: 0.9rem;">Cancel</button>
              <button type="submit" class="btn btn-primary" style="font-size: 0.9rem;">Submit Review</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>



<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  setupQtyButtons();
  setupImageZoom();
  setupAddToCartAjax();
  setupBuyNowAjax();
  highlightDefaultThumbnail();
});

function setupQtyButtons() {
    const qtyInput = document.getElementById('quantity');
    const increaseBtn = document.getElementById('increaseQty');
    const decreaseBtn = document.getElementById('decreaseQty');
    const maxQty = parseInt('{{ default_variant.available_quantity|default:0 }}');
    const minQty = 1;

    if (!qtyInput || !increaseBtn || !decreaseBtn) return;

    // First, remove any previous event listeners to avoid duplication
    increaseBtn.replaceWith(increaseBtn.cloneNode(true));
    decreaseBtn.replaceWith(decreaseBtn.cloneNode(true));

    // Re-grab the new clean buttons
    const newIncreaseBtn = document.getElementById('increaseQty');
    const newDecreaseBtn = document.getElementById('decreaseQty');

    function updateButtons() {
      const value = parseInt(qtyInput.value);
      newIncreaseBtn.disabled = value >= maxQty;
      newDecreaseBtn.disabled = value <= minQty;
    }

    newIncreaseBtn.addEventListener('click', () => {
      let value = parseInt(qtyInput.value);
      if (value < maxQty) {
        qtyInput.value = value + 1;
      }
      updateButtons();
    });

    newDecreaseBtn.addEventListener('click', () => {
      let value = parseInt(qtyInput.value);
      if (value > minQty) {
        qtyInput.value = value - 1;
      }
      updateButtons();
    });

    updateButtons();
  }

  //  Make sure it runs only once
  document.addEventListener('DOMContentLoaded', () => {
    setupQtyButtons();
  });

function changeVariant(variantId) {
  const bookId = document.getElementById('book-id')?.value;
  const variantSelector = document.getElementById('variantSelector');

  if (!bookId) {
    console.error('Book ID not found');
    return;
  }

  variantSelector.disabled = true;

  const payload = JSON.stringify({ variant_id: variantId });

  fetch(`/change_variant/${bookId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken(),
    },
    body: payload,
  })
  .then((res) => res.json())
  .then((data) => {
    if (data.success) {
      updateVariantDetails(data.variant);
    }
  })
  .catch((err) => {
    console.error('Variant update failed:', err);
    showErrorMessage('üö® Could not update variant. Try again.');
  })
  .finally(() => {
    variantSelector.disabled = false;
  });
}

$(document).ready(function () {
  $(".wishlist-toggle-btn").click(function () {
    const button = $(this);
    const variantId = document.getElementById('variantSelector')?.value;

    $.ajax({
      url: "/wishlist/toggle/",
      type: "POST",
      data: {
        product_id: variantId,
        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
      },
      success: function (response) {
        const toast = $("#wishlist-toast");
        toast.removeClass("d-none alert-success alert-danger");

        if (response.added) {
          button.html("üíî");
          toast.addClass("alert-success").text("‚úÖ Added to wishlist!");
        } else if (response.removed) {
          button.html("‚ù§Ô∏è");
          toast.addClass("alert-danger").text("‚ùå Removed from wishlist!");
        }
      },
      error: function () {
        const toast = $("#wishlist-toast");
        toast.removeClass("d-none alert-success").addClass("alert-danger");
        toast.text("‚ùå Something went wrong while updating your wishlist.");
      }
    });
  });
});

function setupImageZoom() {
  const container = document.getElementById('imageContainer');
  const mainImage = document.getElementById('mainImage');
  const zoomedImage = document.getElementById('zoomedImage');

  if (!container || !mainImage || !zoomedImage) return;

  container.addEventListener('mousemove', function (e) {
    zoomedImage.style.backgroundImage = `url('${mainImage.src}')`;
    const rect = container.getBoundingClientRect();
    const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
    const yPercent = ((e.clientY - rect.top) / rect.height) * 100;
    zoomedImage.style.opacity = 1;
    zoomedImage.style.backgroundSize = '200% 200%';
    zoomedImage.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
  });

  container.addEventListener('mouseleave', function () {
    zoomedImage.style.opacity = 0;
  });
}

function changeImage(imageUrl) {
  const mainImage = document.getElementById('mainImage');
  const zoomedImage = document.getElementById('zoomedImage');
  
  if (!mainImage || !zoomedImage) return;
  
  mainImage.src = imageUrl;
  zoomedImage.style.backgroundImage = `url('${imageUrl}')`;

  document.querySelectorAll('.thumbnail').forEach(thumb => {
    thumb.classList.remove('border', 'border-primary');
    if (thumb.src === imageUrl) {
      thumb.classList.add('border', 'border-primary');
    }
  });
}

function updateVariantDetails(variant) {
  const priceBlock = document.getElementById('variantPriceBlock');
  if (priceBlock) {
    if (variant.has_active_offer) {
      let offerBadge = '';
      if (variant.offer_title) {
        offerBadge = `<span class="badge bg-warning text-dark ms-2" style="font-size: 0.75rem;">${variant.offer_title}</span>`;
      }
      priceBlock.innerHTML = `
        <span style="text-decoration: line-through;">‚Çπ${variant.original_price}</span>
        <strong style="color: green;">‚Çπ${variant.discounted_price}</strong>
        <span style="color: red;">(${variant.best_discount_percentage}% OFF)</span>
        ${offerBadge}
      `;
    } else {
      priceBlock.innerHTML = `<span>‚Çπ${variant.price}</span>`;
    }
  }

  const publisherElement = document.getElementById('variantPublisher');
  if (publisherElement) {
    publisherElement.innerText = `Publisher: ${variant.publisher}`;
  }

  const dateElement = document.getElementById('variantDate');
  if (dateElement) {
    dateElement.innerText = variant.published_date;
  }

  const publisherLinkElement = document.getElementById('variantPublisherLink');
  if (publisherLinkElement) {
    publisherLinkElement.innerHTML = `<a href="#" class="text-primary">${variant.publisher}</a>`;
  }

  const pagesElement = document.getElementById('variantPages');
  if (pagesElement) {
    pagesElement.innerText = variant.page;
  }

  const languageElement = document.getElementById('variantLanguage');
  if (languageElement) {
    languageElement.innerText = variant.language;
  }

  updateStockStatus(variant.available_quantity);

  if (variant.images) {
    updateVariantImages(variant.images);
  }
}

function updateStockStatus(availableQuantity) {
  const stockElement = document.getElementById('stockStatus');
  const actionButtons = document.querySelectorAll('.add-to-cart-btn, .buy-now-btn');
  
  if (stockElement) {
    if (availableQuantity > 0) {
      stockElement.className = 'text-success';
      stockElement.innerText = `‚úì In Stock (${availableQuantity} available)`;
      
      actionButtons.forEach(btn => {
        btn.classList.remove('disabled');
        btn.removeAttribute('disabled');
      });
    } else {
      stockElement.className = 'text-danger';
      stockElement.innerText = 'Out of Stock';
      
      actionButtons.forEach(btn => {
        btn.classList.add('disabled');
        btn.setAttribute('disabled', 'true');
      });
    }
  }
}

function updateVariantImages(images) {
  if (images.length > 0) {
    changeImage(images[0]);
  }

  const thumbnails = document.querySelectorAll('.thumbnail');
  
  for (let i = 0; i < thumbnails.length && i < images.length; i++) {
    thumbnails[i].src = images[i];
    thumbnails[i].onclick = () => changeImage(images[i]);
  }
}

function setupAddToCartAjax() {
  const addToCartBtn = document.querySelector('.add-to-cart-btn');
  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', function() {
      const bookId = this.dataset.bookId;
      const variantId = document.getElementById('variantSelector')?.value;
      const quantity = document.getElementById('quantity')?.value || 1;
      
      addToCartAjax(bookId, variantId, quantity, false);
    });
  }
}

function addToCartAjax(bookId, variantId, quantity, isBuyNow = false) {
  const buttons = document.querySelectorAll('.add-to-cart-btn');
  const originalTexts = [];
  
  buttons.forEach((btn, index) => {
    originalTexts[index] = btn.innerText;
    btn.disabled = true;
    btn.innerText = 'Processing...';
  });

  const requestData = {
    variant_id: variantId,
    quantity: parseInt(quantity),
    buy_now: isBuyNow
  };

  fetch(`/add_to_cart/${bookId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCsrfToken(),
    },
    body: JSON.stringify(requestData),
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      if (isBuyNow) {
        showSuccessMessage('Added to cart! Redirecting...');
        if (data.redirect_url) {
          setTimeout(() => {
            window.location.href = data.redirect_url;
          }, 1000);
        }
      } else {
        showSuccessMessage('Added to cart successfully!');
      }
    } else {
      showErrorMessage(data.message || 'Failed to add to cart');
    }
  })
  .catch(error => {
    console.error('Error adding to cart:', error);
    showErrorMessage('Failed to add to cart. Please try again.');
  })
  .finally(() => {
    buttons.forEach((btn, index) => {
      btn.disabled = false;
      btn.innerText = originalTexts[index];
    });
  });
}

function setupBuyNowAjax() {
  const buyNowBtn = document.querySelector('.buy-now-btn');
  if (buyNowBtn) {
    buyNowBtn.addEventListener('click', function() {
      const bookId = this.dataset.bookId;
      const variantId = document.getElementById('variantSelector')?.value;
      const quantity = document.getElementById('quantity')?.value || 1;

      // Reuse the same function, but with buy-now flag set
      addToCartAjax(bookId, variantId, quantity, true);
    });
  }
}

function getCsrfToken() {
  const csrfInput = document.getElementById('csrf_token');
  if (csrfInput) {
    return csrfInput.value;
  }
  
  const csrfMeta = document.querySelector('[name=csrfmiddlewaretoken]');
  if (csrfMeta) {
    return csrfMeta.value;
  }
  
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function showSuccessMessage(message) {
  showToast(message, 'success');
}

function showErrorMessage(message) {
  showToast(message, 'error');
}

function showToast(message, type = 'info') {
  const existingToasts = document.querySelectorAll('.custom-toast');
  existingToasts.forEach(toast => toast.remove());

  const toast = document.createElement('div');
  toast.className = `custom-toast alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    animation: slideIn 0.3s ease-out;
  `;
  
  toast.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;

  if (!document.querySelector('#toast-styles')) {
    const style = document.createElement('style');
    style.id = 'toast-styles';
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
  }

  document.body.appendChild(toast);

  setTimeout(() => {
    if (toast.parentNode) {
      toast.remove();
    }
  }, 5000);
}

function highlightDefaultThumbnail() {
  const defaultThumb = document.querySelector('.thumbnail');
  if (defaultThumb) {
    defaultThumb.classList.add('border', 'border-primary');
  }
}
</script>



{% endblock %}