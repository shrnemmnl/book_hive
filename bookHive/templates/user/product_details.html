
{% extends "base.html" %}
{% load static %}
{% block page_content %}
<div class="container py-5">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'loading_page' %}">Home</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Product Details</li>
    </ol>
  </nav>
  <br>
  <br>

  <div class="row">
    <!-- Book Cover and Variant Images -->
    <div class="col-md-4 mb-4">
      <!-- Main large image with zoom container -->
      <div class="position-relative mb-3" id="imageContainer" style="overflow: hidden;">
        <img id="mainImage" src="{{ default_variant.productimage_set.first.image1.url }}" alt="{{ books.book_title }}"
          class="img-fluid rounded w-100">
        <div id="zoomedImage"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-repeat: no-repeat; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;">
        </div>
      </div>

      <!-- Thumbnail images row -->
      <div class="row">
        {% with images=default_variant.productimage_set.first %}
        <div class="col-4">
          <img src="{{ images.image1.url }}" alt="Image 1" class="img-fluid rounded thumbnail border"
            onclick="changeImage('{{ images.image1.url }}')" style="cursor: pointer;">
        </div>
        <div class="col-4">
          <img src="{{ images.image2.url }}" alt="Image 2" class="img-fluid rounded thumbnail"
            onclick="changeImage('{{ images.image2.url }}')" style="cursor: pointer;">
        </div>
        <div class="col-4">
          <img src="{{ images.image3.url }}" alt="Image 3" class="img-fluid rounded thumbnail"
            onclick="changeImage('{{ images.image3.url }}')" style="cursor: pointer;">
        </div>
        {% endwith %}
      </div>
    </div>

    <!-- Book Details -->
    <div class="col-md-8">
      <h1 class="display-5 fw-bold">{{ books.book_title }}</h1>
      <p class="fs-5">
        By: <a href="#" class="text-primary">{{ books.author }}</a>
      </p>

      <!-- Variant Selector -->
      <div class="mb-3">
        <label for="variantSelector" class="form-label">Select Language:</label>
        <select id="variantSelector" class="form-select" onchange="changeVariant(this.value)">
          {% for variant in variants %}
          <option value="{{ variant.id }}" {% if variant.id == default_variant.id %} selected {% endif %}>
            {{ variant.publisher }} Edition - {{ variant.language }}
          </option>
          {% endfor %}

        </select>
      </div>

      <!-- Variant Price -->
      <div class="mb-3">
        <h3>
          <span id="variantPrice">₹{{ default_variant.price }}</span>
        </h3>
        <p id="variantPublisher">Publisher: {{ default_variant.publisher }}</p>
      </div>

      <!-- Stock Status -->
      <div class="mb-3">
        <p id="stockStatus"
          class="{% if default_variant.available_quantity > 0 %}text-success{% else %}text-danger{% endif %}">
          {% if default_variant.available_quantity > 0 %}
          ✓ In Stock ({{ default_variant.available_quantity }} available)
          {% else %}
          Out of Stock
          {% endif %}
        </p>

        {% if default_variant.available_quantity > 0 %}
        <div class="input-group mb-3" style="max-width: 200px;">
          <button class="btn btn-outline-secondary" type="button" id="decreaseQty">-</button>
          <input type="number" id="quantity" class="form-control text-center" value="1" min="1">
          <button class="btn btn-outline-secondary" type="button" id="increaseQty">+</button>
        </div>
        {% endif %}

      </div>

      <!-- Action Buttons -->
      <div class="mb-4">
        <div class="row">
          <div class="col-md-6 mb-2">
            <button class="btn btn-secondary w-100">Add to Wishlist</button>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-6 mb-2">
            {% if default_variant.available_quantity == 0 %}
            <button class="btn btn-warning w-100 text-white" disabled>
              {% else %}
              <button class="btn btn-warning w-100 text-white" id="add_to_cart">
                {% endif %}
                ADD TO CART
              </button>
          </div>
          <div class="col-md-6 mb-2">
            <button class="btn btn-danger w-100" {% if default_variant.available_quantity == 0 %} disabled {% endif %}>
              BUY NOW
            </button>

          </div>
        </div>
      </div>

      <!-- Book Specifications -->
      <div class="row">
        <div class="col-md-6">
          <table class="table">
            <tbody>
              <tr>
                <th scope="row">Book:</th>
                <td>{{ books.book_title }}</td>
              </tr>
              <tr>
                <th scope="row">Author:</th>
                <td><a href="#" class="text-primary">{{ books.author }}</a></td>
              </tr>
              <tr>
                <th scope="row">Category:</th>
                <td>{{ books.genre.genre_name }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          <table class="table">
            <tbody>
              <tr>
                <th scope="row">Publishing Date:</th>
                <td id="variantDate">{{ default_variant.published_date }}</td>
              </tr>
              <tr>
                <th scope="row">Publisher:</th>
                <td id="variantPublisherLink"><a href="#" class="text-primary">{{ default_variant.publisher }}</a></td>
              </tr>
              <tr>
                <th scope="row">Edition:</th>
                <td>1</td>
              </tr>
              <tr>
                <th scope="row">Number of pages:</th>
                <td id="variantPages">{{ default_variant.page }}</td>
              </tr>
              <tr>
                <th scope="row">Language:</th>
                <td id="variantLanguage">{{ default_variant.language }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Book Summary -->
  <div class="row mt-5">
    <div class="col-12">
      <h2 class="border-bottom pb-2 mb-4">BOOK SUMMARY</h2>
      <p class="lead">
        {{ books.description }}
      </p>
    </div>
  </div>
  <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

</div>
<!-- Book Reviews Section -->
<div class="row mt-5">
  <div class="col-12">
    <h2 class="border-bottom pb-2 mb-4">CUSTOMER REVIEWS</h2>
  </div>
</div>

<div class="row">
  <!-- Overall Rating Panel (Left Side) -->
  <div class="col-md-4 mb-4">
    <div class="card">
      <div class="card-body">
        <h3 class="card-title">Overall Rating</h3>
        <div class="d-flex align-items-center mb-3">
          <div class="display-4 me-3">4.4</div>
          <div>
            <div class="text-warning mb-1">
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-half"></i>
            </div>
            <div class="text-muted">Based on 135 reviews</div>
          </div>
        </div>

        <!-- Rating Distribution -->
        <div class="mb-4">
          <div class="d-flex align-items-center mb-1">
            <div class="text-nowrap me-2">5 stars</div>
            <div class="progress flex-grow-1" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar" style="width: 74%;" aria-valuenow="74" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="ms-2 text-muted small">74%</div>
          </div>
          <div class="d-flex align-items-center mb-1">
            <div class="text-nowrap me-2">4 stars</div>
            <div class="progress flex-grow-1" style="height: 8px;">
              <div class="progress-bar bg-success" role="progressbar" style="width: 14%;" aria-valuenow="14" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="ms-2 text-muted small">14%</div>
          </div>
          <div class="d-flex align-items-center mb-1">
            <div class="text-nowrap me-2">3 stars</div>
            <div class="progress flex-grow-1" style="height: 8px;">
              <div class="progress-bar bg-warning" role="progressbar" style="width: 4%;" aria-valuenow="4" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="ms-2 text-muted small">4%</div>
          </div>
          <div class="d-flex align-items-center mb-1">
            <div class="text-nowrap me-2">2 stars</div>
            <div class="progress flex-grow-1" style="height: 8px;">
              <div class="progress-bar bg-warning" role="progressbar" style="width: 1%;" aria-valuenow="1" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="ms-2 text-muted small">1%</div>
          </div>
          <div class="d-flex align-items-center mb-1">
            <div class="text-nowrap me-2">1 star</div>
            <div class="progress flex-grow-1" style="height: 8px;">
              <div class="progress-bar bg-danger" role="progressbar" style="width: 7%;" aria-valuenow="7" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="ms-2 text-muted small">7%</div>
          </div>
        </div>

        {% comment %} <!-- Feature Ratings -->
        <h5>Rating Categories</h5>
        <div class="mb-2">
          <div class="d-flex justify-content-between">
            <div>Story & Plot</div>
            <div class="text-warning">
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star"></i>
            </div>
          </div>
        </div>
        <div class="mb-2">
          <div class="d-flex justify-content-between">
            <div>Writing Style</div>
            <div class="text-warning">
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-half"></i>
            </div>
          </div>
        </div>
        <div class="mb-2">
          <div class="d-flex justify-content-between">
            <div>Character Development</div>
            <div class="text-warning">
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star"></i>
            </div>
          </div>
        </div>
        <div class="mb-4">
          <div class="d-flex justify-content-between">
            <div>Value for Money</div>
            <div class="text-warning">
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star-fill"></i>
              <i class="bi bi-star"></i>
            </div>
          </div>
        </div> {% endcomment %}

        <!-- Write Review Button -->
        {% if user.is_authenticated %}
  <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#writeReviewModal">
    Write a Review
  </button>
{% else %}
  <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary w-100">
    Write a Review
  </a>
{% endif %}

      </div>
    </div>
  </div>

  <!-- Customer Reviews List (Right Side) -->
  <div class="col-md-8">
    <!-- Filter Controls -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <label for="reviewSort" class="form-label me-2">Sort by:</label>
        <select class="form-select form-select-sm d-inline-block w-auto">
          <option selected>Most Recent</option>
          <option>Highest Rated</option>
          <option>Lowest Rated</option>
        </select>
      </div>
      <div>
        <label class="form-label me-2">Filter:</label>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-secondary active">All</button>
          <button type="button" class="btn btn-outline-secondary">5★</button>
          <button type="button" class="btn btn-outline-secondary">4★</button>
          <button type="button" class="btn btn-outline-secondary">3★</button>
          <button type="button" class="btn btn-outline-secondary">2★</button>
          <button type="button" class="btn btn-outline-secondary">1★</button>
        </div>
      </div>
    </div>

    <!-- Individual Reviews -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <div class="text-warning">
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
          </div>
          <div class="text-muted small">May 10, 2025</div>
        </div>
        <h5 class="card-title">Captivating read from start to finish!</h5>
        <h6 class="card-subtitle mb-2 text-muted">By Sarah J.</h6>
        <p class="card-text">This book exceeded all my expectations. The character development was superb, and the plot twists kept me guessing. I couldn't put it down and finished it in just two days. Would highly recommend to anyone who enjoys this genre!</p>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted small">Verified Purchase</div>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2">
              <i class="bi bi-hand-thumbs-up"></i> Helpful (24)
            </button>
            <button class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-flag"></i> Report
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <div class="text-warning">
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star"></i>
          </div>
          <div class="text-muted small">April 29, 2025</div>
        </div>
        <h5 class="card-title">Great story, minor pacing issues</h5>
        <h6 class="card-subtitle mb-2 text-muted">By Michael T.</h6>
        <p class="card-text">The author has created a fascinating world with complex characters. I was completely immersed in the story. The only reason I'm giving 4 stars instead of 5 is that the middle section dragged a bit. However, the ending was absolutely worth it!</p>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted small">Verified Purchase</div>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2">
              <i class="bi bi-hand-thumbs-up"></i> Helpful (12)
            </button>
            <button class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-flag"></i> Report
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between mb-2">
          <div class="text-warning">
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-fill"></i>
            <i class="bi bi-star-half"></i>
          </div>
          <div class="text-muted small">April 15, 2025</div>
        </div>
        <h5 class="card-title">A thought-provoking masterpiece</h5>
        <h6 class="card-subtitle mb-2 text-muted">By Elena R.</h6>
        <p class="card-text">I've read many books in this genre, and this one stands out for its depth and insight. The author's writing style is elegant and engaging. The themes explored in the story stayed with me long after I finished reading. This book would be perfect for book clubs as there's so much to discuss.</p>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="text-muted small">Verified Purchase</div>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2">
              <i class="bi bi-hand-thumbs-up"></i> Helpful (18)
            </button>
            <button class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-flag"></i> Report
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Review pagination">
      <ul class="pagination justify-content-center">
        <li class="page-item disabled">
          <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
        </li>
        <li class="page-item active"><a class="page-link" href="#">1</a></li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>
        <li class="page-item"><a class="page-link" href="#">3</a></li>
        <li class="page-item">
          <a class="page-link" href="#">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- Write Review Modal -->
<div class="modal fade" id="writeReviewModal" tabindex="-1" aria-labelledby="writeReviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="writeReviewModalLabel">Write a Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method='POST'>
          {% comment %} <div class="mb-3">
            <label for="reviewTitle" class="form-label">Review Title</label>
            <input type="text" class="form-control" id="reviewTitle" placeholder="Summarize your experience">
          </div> {% endcomment %}
          
          <div class="mb-3">
            <label class="form-label">Overall Rating</label>
            <div class="rating-stars mb-2">
              <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="overallRating" id="rating1" value="1" autocomplete="off">
                <label class="btn btn-outline-warning" for="rating1">1★</label>
                
                <input type="radio" class="btn-check" name="overallRating" id="rating2" value="2" autocomplete="off">
                <label class="btn btn-outline-warning" for="rating2">2★</label>
                
                <input type="radio" class="btn-check" name="overallRating" id="rating3" value="3" autocomplete="off">
                <label class="btn btn-outline-warning" for="rating3">3★</label>
                
                <input type="radio" class="btn-check" name="overallRating" id="rating4" value="4" autocomplete="off">
                <label class="btn btn-outline-warning" for="rating4">4★</label>
                
                <input type="radio" class="btn-check" name="overallRating" id="rating5" value="5" autocomplete="off" checked>
                <label class="btn btn-outline-warning" for="rating5">5★</label>
              </div>
            </div>
          </div>
          
          {% comment %} <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Story & Plot</label>
              <select class="form-select">
                <option>5 stars</option>
                <option>4 stars</option>
                <option>3 stars</option>
                <option>2 stars</option>
                <option>1 star</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Writing Style</label>
              <select class="form-select">
                <option>5 stars</option>
                <option>4 stars</option>
                <option>3 stars</option>
                <option>2 stars</option>
                <option>1 star</option>
              </select>
            </div>
          </div> {% endcomment %}
          
          {% comment %} <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Character Development</label>
              <select class="form-select">
                <option>5 stars</option>
                <option>4 stars</option>
                <option>3 stars</option>
                <option>2 stars</option>
                <option>1 star</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Value for Money</label>
              <select class="form-select">
                <option>5 stars</option>
                <option>4 stars</option>
                <option>3 stars</option>
                <option>2 stars</option>
                <option>1 star</option>
              </select>
            </div>
          </div> {% endcomment %}
          
          <div class="mb-3">
            <label for="reviewText" class="form-label">Your Review</label>
            <textarea class="form-control" name="comment" id="reviewText" rows="5" placeholder="What did you like or dislike?"></textarea>
          </div>
          
          {% comment %} <div class="mb-3">
            <label for="reviewerName" class="form-label">Your Name</label>
            <input type="text" class="form-control" id="reviewerName" placeholder="Enter your name (or nickname)">
          </div> {% endcomment %}
          
          {% comment %} <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="verifiedPurchase" checked disabled>
              <label class="form-check-label" for="verifiedPurchase">
                Verified Purchase
              </label>
            </div>
          </div> {% endcomment %}
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary">Submit Review</button>
      </div>
      </form>
      <div>
                {% for message in messages %}
                <div
                  class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}"
                  role="alert"
                >
                  {{ message }}
                </div>
                {% endfor %}
              </div>
    </div>
  </div>
</div>

<!-- Add Bootstrap Icons CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">

<script>
  // Function to change the main image when clicking on thumbnails
  function changeImage(imageUrl) {
    // Update the main image
    document.getElementById('mainImage').src = imageUrl;

    // Update the zoomed image background immediately
    const zoomedImage = document.getElementById('zoomedImage');
    zoomedImage.style.backgroundImage = `url('${imageUrl}')`;

    // Highlight the selected thumbnail
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      if (thumb.getAttribute('src') === imageUrl) {
        thumb.classList.add('border', 'border-primary');
      } else {
        thumb.classList.remove('border', 'border-primary');
      }
    });
  }

  // Add zoom functionality
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('imageContainer');
    const mainImage = document.getElementById('mainImage');
    const zoomedImage = document.getElementById('zoomedImage');

    // Set initial zoom background image
    zoomedImage.style.backgroundImage = `url('${mainImage.src}')`;

    // Add zoom effect on mousemove
    container.addEventListener('mousemove', function (e) {
      // Make sure the zoomed image always matches the current main image
      zoomedImage.style.backgroundImage = `url('${mainImage.src}')`;

      // Get cursor position
      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Calculate position as percentage
      const xPercent = x / rect.width * 100;
      const yPercent = y / rect.height * 100;

      // Show the zoomed layer
      zoomedImage.style.opacity = 1;

      // Set background size to larger value for zoom effect
      zoomedImage.style.backgroundSize = '200% 200%';

      // Position the background image inversely to mouse movement
      zoomedImage.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
    });

    // Hide zoom effect when mouse leaves
    container.addEventListener('mouseleave', function () {
      zoomedImage.style.opacity = 0;
    });

    // Highlight the first thumbnail by default
    document.querySelector('.thumbnail').classList.add('border', 'border-primary');
  });

  // Update existing changeVariant function to properly handle the zoom
  function changeVariant(variantId) {
    // Use fetch to get variant data via AJAX
    fetch(`/get-variant-details/${variantId}/`)
      .then(response => response.json())
      .then(data => {
        // Update variant details
        document.getElementById('variantPrice').innerText = `₹${data.price}`;
        document.getElementById('variantPublisher').innerText = `Publisher: ${data.publisher}`;
        document.getElementById('variantDate').innerText = data.published_date;
        document.getElementById('variantPublisherLink').innerHTML = `<a href="#" class="text-primary">${data.publisher}</a>`;
        document.getElementById('variantPages').innerText = data.page;
        document.getElementById('variantLanguage').innerText = data.language;

        // Update stock status
        const stockElement = document.getElementById('stockStatus');
        if (data.available_quantity > 0) {
          stockElement.className = 'text-success';
          stockElement.innerText = `✓ In Stock (${data.available_quantity} available)`;

          // Enable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = false;
          });
        } else {
          stockElement.className = 'text-danger';
          stockElement.innerText = 'Out of Stock';

          // Disable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = true;
          });
        }

        // Update images
        const mainImage = document.getElementById('mainImage');
        mainImage.src = data.images.image1;

        // Update the zoom background immediately
        const zoomedImage = document.getElementById('zoomedImage');
        zoomedImage.style.backgroundImage = `url('${data.images.image1}')`;

        // Update thumbnails with onclick handlers
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails[0].src = data.images.image1;
        thumbnails[0].onclick = function () { changeImage(data.images.image1); };
        thumbnails[0].classList.add('border', 'border-primary');

        thumbnails[1].src = data.images.image2;
        thumbnails[1].onclick = function () { changeImage(data.images.image2); };
        thumbnails[1].classList.remove('border', 'border-primary');

        thumbnails[2].src = data.images.image3;
        thumbnails[2].onclick = function () { changeImage(data.images.image3); };
        thumbnails[2].classList.remove('border', 'border-primary');
      })
      .catch(error => console.error('Error loading variant data:', error));
  }
  // JavaScript to handle variant changes
  function changeVariant(variantId) {
    // Use fetch to get variant data via AJAX
    fetch(`/get-variant-details/${variantId}/`)
      .then(response => response.json())
      .then(data => {
        // Update variant details
        document.getElementById('variantPrice').innerText = `₹${data.price}`;
        document.getElementById('variantPublisher').innerText = `Publisher: ${data.publisher}`;
        document.getElementById('variantDate').innerText = data.published_date;
        document.getElementById('variantPublisherLink').innerHTML = `<a href="#" class="text-primary">${data.publisher}</a>`;
        document.getElementById('variantPages').innerText = data.page;
        document.getElementById('variantLanguage').innerText = data.language;

        // Update stock status
        const stockElement = document.getElementById('stockStatus');
        if (data.available_quantity > 0) {
          stockElement.className = 'text-success';
          stockElement.innerText = `✓ In Stock (${data.available_quantity} available)`;

          // Enable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = false;
          });
        } else {
          stockElement.className = 'text-danger';
          stockElement.innerText = 'Out of Stock';

          // Disable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = true;
          });
        }

        // Update images
        document.getElementById('mainImage').src = data.images.image1;

        // Update thumbnails with onclick handlers
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails[0].src = data.images.image1;
        thumbnails[0].onclick = function () { changeImage(data.images.image1); };

        thumbnails[1].src = data.images.image2;
        thumbnails[1].onclick = function () { changeImage(data.images.image2); };

        thumbnails[2].src = data.images.image3;
        thumbnails[2].onclick = function () { changeImage(data.images.image3); };
      })
      .catch(error => console.error('Error loading variant data:', error));
  }

  // Function to change the main image when clicking on thumbnails
  function changeImage(imageUrl) {
    document.getElementById('mainImage').src = imageUrl;
  }

  //***************************
  document.addEventListener('DOMContentLoaded', function () {
    const addToCartBtn = document.getElementById('add_to_cart');
    const increaseQty = document.getElementById('increaseQty');
    const decreaseQty = document.getElementById('decreaseQty');
    const quantityInput = document.getElementById('quantity');

    // Quantity +/- handlers
    increaseQty?.addEventListener('click', () => {
      let qty = parseInt(quantityInput.value);
      quantityInput.value = qty + 1;
    });

    decreaseQty?.addEventListener('click', () => {
      let qty = parseInt(quantityInput.value);
      if (qty > 1) quantityInput.value = qty - 1;
    });

    // Add to cart AJAX
    addToCartBtn?.addEventListener('click', function () {
      const variantId = document.getElementById('variantSelector').value;
      const quantity = document.getElementById('quantity').value;
      const csrfToken = document.getElementById('csrf_token').value;

      fetch('/add_to_cart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
          variant_id: variantId,
          quantity: quantity,
        }),
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('✅ Added to cart!');
            // You can trigger a toast or update cart badge here
          } else {
            alert('❌ ' + (data.message || 'Something went wrong.'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('🚨 Failed to add to cart.');
        });
    });
  });

  //***********
  document.getElementById('decreaseQty').addEventListener('click', function () {
    const qtyInput = document.getElementById('quantity');
    let currentQty = parseInt(qtyInput.value);
    if (currentQty > 1) {
      qtyInput.value = currentQty - 1;
    }
  });

  document.getElementById('increaseQty').addEventListener('click', function () {
    const qtyInput = document.getElementById('quantity');
    qtyInput.value = parseInt(qtyInput.value) + 1;
  });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}