
{% extends "base.html" %}
{% load static %}
{% block page_content %}
<div class="container py-5">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'loading_page' %}">Home</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Product Details</li>
    </ol>
  </nav>
  <br>
  <br>

  <div class="row">
    <!-- Book Cover and Variant Images -->
    <div class="col-md-4 mb-4">
      <!-- Main large image with zoom container -->
      <div class="position-relative mb-3" id="imageContainer" style="overflow: hidden;">
        <img id="mainImage" src="{{ default_variant.productimage_set.first.image1.url }}" alt="{{ books.book_title }}"
          class="img-fluid rounded w-100">
        <div id="zoomedImage"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-repeat: no-repeat; opacity: 0; pointer-events: none; transition: opacity 0.2s ease;">
        </div>
      </div>

      <!-- Thumbnail images row -->
      <div class="row">
        {% with images=default_variant.productimage_set.first %}
        <div class="col-4">
          <img src="{{ images.image1.url }}" alt="Image 1" class="img-fluid rounded thumbnail border"
            onclick="changeImage('{{ images.image1.url }}')" style="cursor: pointer;">
        </div>
        <div class="col-4">
          <img src="{{ images.image2.url }}" alt="Image 2" class="img-fluid rounded thumbnail"
            onclick="changeImage('{{ images.image2.url }}')" style="cursor: pointer;">
        </div>
        <div class="col-4">
          <img src="{{ images.image3.url }}" alt="Image 3" class="img-fluid rounded thumbnail"
            onclick="changeImage('{{ images.image3.url }}')" style="cursor: pointer;">
        </div>
        {% endwith %}
      </div>
    </div>

    <!-- Book Details -->
    <div class="col-md-8">
      <h1 class="display-5 fw-bold">{{ books.book_title }}</h1>
      <p class="fs-5">
        By: <a href="#" class="text-primary">{{ books.author }}</a>
      </p>

      <!-- Variant Selector -->
      <div class="mb-3">
        <label for="variantSelector" class="form-label">Select Language:</label>
        <select id="variantSelector" class="form-select" onchange="changeVariant(this.value)">
          {% for variant in variants %}
          <option value="{{ variant.id }}" {% if variant.id == default_variant.id %} selected {% endif %}>
            {{ variant.publisher }} Edition - {{ variant.language }}
          </option>
          {% endfor %}

        </select>
      </div>

      <!-- Variant Price -->
      <div class="mb-3">
        <h3>
          <span id="variantPrice">â‚¹{{ default_variant.price }}</span>
        </h3>
        <p id="variantPublisher">Publisher: {{ default_variant.publisher }}</p>
      </div>

      <!-- Stock Status -->
      <div class="mb-3">
        <p id="stockStatus"
          class="{% if default_variant.available_quantity > 0 %}text-success{% else %}text-danger{% endif %}">
          {% if default_variant.available_quantity > 0 %}
          âœ“ In Stock ({{ default_variant.available_quantity }} available)
          {% else %}
          Out of Stock
          {% endif %}
        </p>

        {% if default_variant.available_quantity > 0 %}
        <div class="input-group mb-3" style="max-width: 200px;">
          <button class="btn btn-outline-secondary" type="button" id="decreaseQty">-</button>
          <input type="number" id="quantity" class="form-control text-center" value="1" min="1">
          <button class="btn btn-outline-secondary" type="button" id="increaseQty">+</button>
        </div>
        {% endif %}

      </div>

      <!-- Action Buttons -->
      <div class="mb-4">
        <div class="row">
          <div class="col-md-6 mb-2">
            <button class="btn btn-secondary w-100">Add to Wishlist</button>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-6 mb-2">
            {% if default_variant.available_quantity == 0 %}
            <button class="btn btn-warning w-100 text-white" disabled>
              {% else %}
              <button class="btn btn-warning w-100 text-white" id="add_to_cart">
                {% endif %}
                ADD TO CART
              </button>
          </div>
          <div class="col-md-6 mb-2">
            <button class="btn btn-danger w-100" {% if default_variant.available_quantity == 0 %} disabled {% endif %}>
              BUY NOW
            </button>

          </div>
        </div>
      </div>

      <!-- Book Specifications -->
      <div class="row">
        <div class="col-md-6">
          <table class="table">
            <tbody>
              <tr>
                <th scope="row">Book:</th>
                <td>{{ books.book_title }}</td>
              </tr>
              <tr>
                <th scope="row">Author:</th>
                <td><a href="#" class="text-primary">{{ books.author }}</a></td>
              </tr>
              <tr>
                <th scope="row">Category:</th>
                <td>{{ books.genre.genre_name }}</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          <table class="table">
            <tbody>
              <tr>
                <th scope="row">Publishing Date:</th>
                <td id="variantDate">{{ default_variant.published_date }}</td>
              </tr>
              <tr>
                <th scope="row">Publisher:</th>
                <td id="variantPublisherLink"><a href="#" class="text-primary">{{ default_variant.publisher }}</a></td>
              </tr>
              <tr>
                <th scope="row">Edition:</th>
                <td>1</td>
              </tr>
              <tr>
                <th scope="row">Number of pages:</th>
                <td id="variantPages">{{ default_variant.page }}</td>
              </tr>
              <tr>
                <th scope="row">Language:</th>
                <td id="variantLanguage">{{ default_variant.language }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Book Summary -->
  <div class="row mt-5">
    <div class="col-12">
      <h2 class="border-bottom pb-2 mb-4">BOOK SUMMARY</h2>
      <p class="lead">
        {{ books.description }}
      </p>
    </div>
  </div>
  <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

</div>

<script>
  // Function to change the main image when clicking on thumbnails
  function changeImage(imageUrl) {
    // Update the main image
    document.getElementById('mainImage').src = imageUrl;

    // Update the zoomed image background immediately
    const zoomedImage = document.getElementById('zoomedImage');
    zoomedImage.style.backgroundImage = `url('${imageUrl}')`;

    // Highlight the selected thumbnail
    document.querySelectorAll('.thumbnail').forEach(thumb => {
      if (thumb.getAttribute('src') === imageUrl) {
        thumb.classList.add('border', 'border-primary');
      } else {
        thumb.classList.remove('border', 'border-primary');
      }
    });
  }

  // Add zoom functionality
  document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('imageContainer');
    const mainImage = document.getElementById('mainImage');
    const zoomedImage = document.getElementById('zoomedImage');

    // Set initial zoom background image
    zoomedImage.style.backgroundImage = `url('${mainImage.src}')`;

    // Add zoom effect on mousemove
    container.addEventListener('mousemove', function (e) {
      // Make sure the zoomed image always matches the current main image
      zoomedImage.style.backgroundImage = `url('${mainImage.src}')`;

      // Get cursor position
      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // Calculate position as percentage
      const xPercent = x / rect.width * 100;
      const yPercent = y / rect.height * 100;

      // Show the zoomed layer
      zoomedImage.style.opacity = 1;

      // Set background size to larger value for zoom effect
      zoomedImage.style.backgroundSize = '200% 200%';

      // Position the background image inversely to mouse movement
      zoomedImage.style.backgroundPosition = `${xPercent}% ${yPercent}%`;
    });

    // Hide zoom effect when mouse leaves
    container.addEventListener('mouseleave', function () {
      zoomedImage.style.opacity = 0;
    });

    // Highlight the first thumbnail by default
    document.querySelector('.thumbnail').classList.add('border', 'border-primary');
  });

  // Update existing changeVariant function to properly handle the zoom
  function changeVariant(variantId) {
    // Use fetch to get variant data via AJAX
    fetch(`/get-variant-details/${variantId}/`)
      .then(response => response.json())
      .then(data => {
        // Update variant details
        document.getElementById('variantPrice').innerText = `â‚¹${data.price}`;
        document.getElementById('variantPublisher').innerText = `Publisher: ${data.publisher}`;
        document.getElementById('variantDate').innerText = data.published_date;
        document.getElementById('variantPublisherLink').innerHTML = `<a href="#" class="text-primary">${data.publisher}</a>`;
        document.getElementById('variantPages').innerText = data.page;
        document.getElementById('variantLanguage').innerText = data.language;

        // Update stock status
        const stockElement = document.getElementById('stockStatus');
        if (data.available_quantity > 0) {
          stockElement.className = 'text-success';
          stockElement.innerText = `âœ“ In Stock (${data.available_quantity} available)`;

          // Enable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = false;
          });
        } else {
          stockElement.className = 'text-danger';
          stockElement.innerText = 'Out of Stock';

          // Disable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = true;
          });
        }

        // Update images
        const mainImage = document.getElementById('mainImage');
        mainImage.src = data.images.image1;

        // Update the zoom background immediately
        const zoomedImage = document.getElementById('zoomedImage');
        zoomedImage.style.backgroundImage = `url('${data.images.image1}')`;

        // Update thumbnails with onclick handlers
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails[0].src = data.images.image1;
        thumbnails[0].onclick = function () { changeImage(data.images.image1); };
        thumbnails[0].classList.add('border', 'border-primary');

        thumbnails[1].src = data.images.image2;
        thumbnails[1].onclick = function () { changeImage(data.images.image2); };
        thumbnails[1].classList.remove('border', 'border-primary');

        thumbnails[2].src = data.images.image3;
        thumbnails[2].onclick = function () { changeImage(data.images.image3); };
        thumbnails[2].classList.remove('border', 'border-primary');
      })
      .catch(error => console.error('Error loading variant data:', error));
  }
  // JavaScript to handle variant changes
  function changeVariant(variantId) {
    // Use fetch to get variant data via AJAX
    fetch(`/get-variant-details/${variantId}/`)
      .then(response => response.json())
      .then(data => {
        // Update variant details
        document.getElementById('variantPrice').innerText = `â‚¹${data.price}`;
        document.getElementById('variantPublisher').innerText = `Publisher: ${data.publisher}`;
        document.getElementById('variantDate').innerText = data.published_date;
        document.getElementById('variantPublisherLink').innerHTML = `<a href="#" class="text-primary">${data.publisher}</a>`;
        document.getElementById('variantPages').innerText = data.page;
        document.getElementById('variantLanguage').innerText = data.language;

        // Update stock status
        const stockElement = document.getElementById('stockStatus');
        if (data.available_quantity > 0) {
          stockElement.className = 'text-success';
          stockElement.innerText = `âœ“ In Stock (${data.available_quantity} available)`;

          // Enable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = false;
          });
        } else {
          stockElement.className = 'text-danger';
          stockElement.innerText = 'Out of Stock';

          // Disable buttons
          document.querySelectorAll('.btn-warning, .btn-danger').forEach(btn => {
            btn.disabled = true;
          });
        }

        // Update images
        document.getElementById('mainImage').src = data.images.image1;

        // Update thumbnails with onclick handlers
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails[0].src = data.images.image1;
        thumbnails[0].onclick = function () { changeImage(data.images.image1); };

        thumbnails[1].src = data.images.image2;
        thumbnails[1].onclick = function () { changeImage(data.images.image2); };

        thumbnails[2].src = data.images.image3;
        thumbnails[2].onclick = function () { changeImage(data.images.image3); };
      })
      .catch(error => console.error('Error loading variant data:', error));
  }

  // Function to change the main image when clicking on thumbnails
  function changeImage(imageUrl) {
    document.getElementById('mainImage').src = imageUrl;
  }

  //***************************
  document.addEventListener('DOMContentLoaded', function () {
    const addToCartBtn = document.getElementById('add_to_cart');
    const increaseQty = document.getElementById('increaseQty');
    const decreaseQty = document.getElementById('decreaseQty');
    const quantityInput = document.getElementById('quantity');

    // Quantity +/- handlers
    increaseQty?.addEventListener('click', () => {
      let qty = parseInt(quantityInput.value);
      quantityInput.value = qty + 1;
    });

    decreaseQty?.addEventListener('click', () => {
      let qty = parseInt(quantityInput.value);
      if (qty > 1) quantityInput.value = qty - 1;
    });

    // Add to cart AJAX
    addToCartBtn?.addEventListener('click', function () {
      const variantId = document.getElementById('variantSelector').value;
      const quantity = document.getElementById('quantity').value;
      const csrfToken = document.getElementById('csrf_token').value;

      fetch('/add_to_cart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
          variant_id: variantId,
          quantity: quantity,
        }),
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('âœ… Added to cart!');
            // You can trigger a toast or update cart badge here
          } else {
            alert('âŒ ' + (data.message || 'Something went wrong.'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('ðŸš¨ Failed to add to cart.');
        });
    });
  });

  //***********
  document.getElementById('decreaseQty').addEventListener('click', function () {
    const qtyInput = document.getElementById('quantity');
    let currentQty = parseInt(qtyInput.value);
    if (currentQty > 1) {
      qtyInput.value = currentQty - 1;
    }
  });

  document.getElementById('increaseQty').addEventListener('click', function () {
    const qtyInput = document.getElementById('quantity');
    qtyInput.value = parseInt(qtyInput.value) + 1;
  });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}