{% extends 'admin/admin_base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Period Filter -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="GET" action="{% url 'admin_dashboard' %}" class="mb-0">
            <div class="row align-items-end">
              <div class="col-md-3">
                <label class="form-label fw-semibold">View Period</label>
                <select name="filter" class="form-select" id="filterType">
                  <option value="today" {% if filter_type == 'today' %}selected{% endif %}>Today</option>
                  <option value="week" {% if filter_type == 'week' %}selected{% endif %}>Past 7 Days</option>
                  <option value="month" {% if filter_type == 'month' %}selected{% endif %}>Past 30 Days</option>
                  <option value="year" {% if filter_type == 'year' %}selected{% endif %}>Past Year</option>
                  <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All Time</option>
                </select>
              </div>
              <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                  <i class="bi bi-funnel me-1"></i> Apply
                </button>
              </div>
              <div class="col-md-7 text-md-end">
                <span class="badge bg-secondary">Showing: <strong>{{ filter_label }}</strong></span>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card border-primary shadow-sm">
        <div class="card-body text-center">
          <i class="bi bi-cart-check fs-1 text-primary mb-2"></i>
          <h6 class="text-muted mb-1">Total Orders</h6>
          <h3 class="mb-0 text-primary fw-bold">{{ total_orders }}</h3>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-success shadow-sm">
        <div class="card-body text-center">
          <i class="bi bi-cash-stack fs-1 text-success mb-2"></i>
          <h6 class="text-muted mb-1">Total Revenue</h6>
          <h3 class="mb-0 text-success fw-bold">₹{{ total_revenue|floatformat:2 }}</h3>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-info shadow-sm">
        <div class="card-body text-center">
          <i class="bi bi-graph-up-arrow fs-1 text-info mb-2"></i>
          <h6 class="text-muted mb-1">Avg Order Value</h6>
          <h3 class="mb-0 text-info fw-bold">₹{{ avg_order_value|floatformat:2 }}</h3>
        </div>
      </div>
    </div>
    
    <div class="col-md-3">
      <div class="card border-warning shadow-sm">
        <div class="card-body text-center">
          <i class="bi bi-box-seam fs-1 text-warning mb-2"></i>
          <h6 class="text-muted mb-1">Total Categories</h6>
          <h3 class="mb-0 text-warning fw-bold">{{ best_selling_categories|length }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Sales Performance</h5>
        </div>
        <div class="card-body">
          <canvas id="salesChart" height="80"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Best Selling Products & Categories -->
  <div class="row">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Top 10 Best Selling Products</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th width="40">#</th>
                  <th>Product</th>
                  <th class="text-end">Sold</th>
                  <th class="text-end">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {% for product in best_selling_products %}
                <tr>
                  <td class="fw-bold text-muted">{{ forloop.counter }}</td>
                  <td>
                    <div>
                      <strong class="d-block">{{ product.product_variant__product__book_title }}</strong>
                      <small class="text-muted">{{ product.product_variant__product__author }}</small>
                    </div>
                  </td>
                  <td class="text-end fw-semibold">{{ product.total_sold }}</td>
                  <td class="text-end text-success fw-bold">₹{{ product.total_revenue|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No sales data available
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-bookmark-fill me-2"></i>Top 10 Best Selling Categories</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th width="40">#</th>
                  <th>Category</th>
                  <th class="text-end">Sold</th>
                  <th class="text-end">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {% for category in best_selling_categories %}
                <tr>
                  <td class="fw-bold text-muted">{{ forloop.counter }}</td>
                  <td>
                    <strong>{{ category.product_variant__product__genre__genre_name|title }}</strong>
                  </td>
                  <td class="text-end fw-semibold">{{ category.total_sold }}</td>
                  <td class="text-end text-success fw-bold">₹{{ category.total_revenue|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                    No category data available
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('salesChart');
    
    if (ctx) {
        const chartData = {
            labels: {{ chart_labels|safe }},
            datasets: [
                {
                    label: 'Revenue (₹)',
                    data: {{ chart_revenue|safe }},
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Orders',
                    data: {{ chart_orders|safe }},
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ]
        };
        
        new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Revenue: ₹' + context.parsed.y.toFixed(2);
                                } else {
                                    return 'Orders: ' + context.parsed.y;
                                }
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Revenue (₹)'
                        },
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toFixed(0);
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Orders'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}
