{% extends 'admin/admin_base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1" style="color: #1e293b; font-size: 1.75rem;">
        <i class="bi bi-speedometer2 text-primary me-2"></i>Dashboard
      </h2>
      <p class="text-muted mb-0" style="font-size: 0.9rem;">
        <i class="bi bi-calendar3 me-1"></i>{{ filter_label }}
      </p>
    </div>
  </div>

  <!-- Period Filter -->
  <div class="card shadow-sm mb-4 border-0" style="border-radius: 10px;">
    <div class="card-body p-3">
      <form method="GET" action="{% url 'admin_dashboard' %}" class="mb-0">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label class="form-label fw-semibold mb-2" style="font-size: 0.9rem; color: #475569;">View Period</label>
            <select name="filter" class="form-select form-select-sm" id="filterType" style="border-radius: 6px;">
              <option value="today" {% if filter_type == 'today' %}selected{% endif %}>Today</option>
              <option value="week" {% if filter_type == 'week' %}selected{% endif %}>Past 7 Days</option>
              <option value="month" {% if filter_type == 'month' %}selected{% endif %}>Past 30 Days</option>
              <option value="year" {% if filter_type == 'year' %}selected{% endif %}>Past Year</option>
              <option value="all" {% if filter_type == 'all' %}selected{% endif %}>All Time</option>
            </select>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-primary btn-sm w-100" style="border-radius: 6px;">
              <i class="bi bi-funnel me-1"></i> Apply Filter
            </button>
          </div>
          <div class="col-md-5 text-md-end d-flex align-items-end justify-content-end">
            <span class="badge bg-secondary px-3 py-2" style="font-size: 0.85rem; font-weight: 500;">
              <i class="bi bi-info-circle me-1"></i>Showing: <strong>{{ filter_label }}</strong>
            </span>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card h-100 shadow-sm border-0" style="border-radius: 12px; border-left: 4px solid #3b82f6 !important;">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-primary bg-opacity-10 rounded-circle p-3" style="width: 55px; height: 55px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-cart-check fs-4 text-primary"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <p class="text-muted mb-0" style="font-size: 0.75rem; font-weight: 500;">Total Orders</p>
              <h4 class="mb-0 fw-bold text-primary">{{ total_orders }}</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card h-100 shadow-sm border-0" style="border-radius: 12px; border-left: 4px solid #10b981 !important;">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-success bg-opacity-10 rounded-circle p-3" style="width: 55px; height: 55px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-cash-stack fs-4 text-success"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <p class="text-muted mb-0" style="font-size: 0.75rem; font-weight: 500;">Total Revenue</p>
              <h4 class="mb-0 fw-bold text-success" style="font-size: 1rem;">₹{{ total_revenue|floatformat:2 }}</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card h-100 shadow-sm border-0" style="border-radius: 12px; border-left: 4px solid #06b6d4 !important;">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-info bg-opacity-10 rounded-circle p-3" style="width: 55px; height: 55px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-graph-up-arrow fs-4 text-info"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <p class="text-muted mb-0" style="font-size: 0.75rem; font-weight: 500;">Avg Order Value</p>
              <h4 class="mb-0 fw-bold text-info" style="font-size: 1rem;">₹{{ avg_order_value|floatformat:2 }}</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
      <div class="card h-100 shadow-sm border-0" style="border-radius: 12px; border-left: 4px solid #f59e0b !important;">
        <div class="card-body p-3">
          <div class="d-flex align-items-center">
            <div class="flex-shrink-0">
              <div class="bg-warning bg-opacity-10 rounded-circle p-3" style="width: 55px; height: 55px; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-box-seam fs-4 text-warning"></i>
              </div>
            </div>
            <div class="flex-grow-1 ms-3">
              <p class="text-muted mb-0" style="font-size: 0.75rem; font-weight: 500;">Total Categories</p>
              <h4 class="mb-0 fw-bold text-warning">{{ best_selling_categories|length }}</h4>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0" style="border-radius: 10px;">
        <div class="card-header bg-white border-0 pb-0 pt-3" style="border-radius: 10px 10px 0 0;">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold" style="color: #1e293b; font-size: 1.1rem;">
              <i class="bi bi-bar-chart-line me-2 text-primary"></i>Sales Performance
            </h5>
            <span class="badge bg-primary bg-opacity-10 text-primary" style="font-size: 0.75rem;">Revenue & Orders</span>
          </div>
        </div>
        <div class="card-body p-4">
          <canvas id="salesChart" style="max-height: 350px;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Best Selling Products & Categories -->
  <div class="row g-3">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100" style="border-radius: 10px;">
        <div class="card-header bg-white border-0 pb-0 pt-3" style="border-radius: 10px 10px 0 0;">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold" style="color: #1e293b; font-size: 1.1rem;">
              <i class="bi bi-trophy-fill me-2 text-success"></i>Top 10 Best Selling Products
            </h5>
            <span class="badge bg-success bg-opacity-10 text-success" style="font-size: 0.75rem;">Top 10</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" style="font-size: 0.875rem;">
              <thead style="background-color: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                <tr>
                  <th class="fw-semibold text-uppercase text-center" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px; width: 50px;">#</th>
                  <th class="fw-semibold text-uppercase" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px;">Product</th>
                  <th class="fw-semibold text-uppercase text-end" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px;">Sold</th>
                  <th class="fw-semibold text-uppercase text-end" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px;">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {% for product in best_selling_products %}
                <tr style="border-bottom: 1px solid #f1f5f9;">
                  <td class="text-center" style="padding: 1rem 0.75rem;">
                    <span class="badge bg-light text-dark fw-bold" style="font-size: 0.85rem; padding: 0.4rem 0.6rem;">{{ forloop.counter }}</span>
                  </td>
                  <td style="padding: 1rem 0.75rem;">
                    <div>
                      <div class="fw-medium" style="color: #1e293b; font-size: 0.9rem; line-height: 1.4;">{{ product.product_variant__product__book_title }}</div>
                      <small class="text-muted" style="font-size: 0.8rem;">{{ product.product_variant__product__author }}</small>
                    </div>
                  </td>
                  <td class="text-end fw-semibold" style="color: #1e293b; padding: 1rem 0.75rem;">{{ product.total_sold }}</td>
                  <td class="text-end fw-bold" style="color: #10b981; padding: 1rem 0.75rem; font-size: 0.95rem;">₹{{ product.total_revenue|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-5">
                    <div class="py-4">
                      <i class="bi bi-inbox fs-1 text-muted d-block mb-3" style="opacity: 0.5;"></i>
                      <p class="text-muted mb-0" style="font-size: 0.95rem;">No sales data available</p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100" style="border-radius: 10px;">
        <div class="card-header bg-white border-0 pb-0 pt-3" style="border-radius: 10px 10px 0 0;">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 fw-semibold" style="color: #1e293b; font-size: 1.1rem;">
              <i class="bi bi-bookmark-fill me-2 text-info"></i>Top 10 Best Selling Categories
            </h5>
            <span class="badge bg-info bg-opacity-10 text-info" style="font-size: 0.75rem;">Top 10</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" style="font-size: 0.875rem;">
              <thead style="background-color: #f8fafc; border-bottom: 2px solid #e2e8f0;">
                <tr>
                  <th class="fw-semibold text-uppercase text-center" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px; width: 50px;">#</th>
                  <th class="fw-semibold text-uppercase" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px;">Category</th>
                  <th class="fw-semibold text-uppercase text-end" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px;">Sold</th>
                  <th class="fw-semibold text-uppercase text-end" style="color: #64748b; font-size: 0.75rem; padding: 1rem 0.75rem; letter-spacing: 0.5px;">Revenue</th>
                </tr>
              </thead>
              <tbody>
                {% for category in best_selling_categories %}
                <tr style="border-bottom: 1px solid #f1f5f9;">
                  <td class="text-center" style="padding: 1rem 0.75rem;">
                    <span class="badge bg-light text-dark fw-bold" style="font-size: 0.85rem; padding: 0.4rem 0.6rem;">{{ forloop.counter }}</span>
                  </td>
                  <td style="padding: 1rem 0.75rem;">
                    <div class="fw-medium" style="color: #1e293b; font-size: 0.9rem;">{{ category.product_variant__product__genre__genre_name|title }}</div>
                  </td>
                  <td class="text-end fw-semibold" style="color: #1e293b; padding: 1rem 0.75rem;">{{ category.total_sold }}</td>
                  <td class="text-end fw-bold" style="color: #10b981; padding: 1rem 0.75rem; font-size: 0.95rem;">₹{{ category.total_revenue|floatformat:2 }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center py-5">
                    <div class="py-4">
                      <i class="bi bi-inbox fs-1 text-muted d-block mb-3" style="opacity: 0.5;"></i>
                      <p class="text-muted mb-0" style="font-size: 0.95rem;">No category data available</p>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('salesChart');
    
    if (ctx) {
        const chartData = {
            labels: {{ chart_labels|safe }},
            datasets: [
                {
                    label: 'Revenue (₹)',
                    data: {{ chart_revenue|safe }},
                    borderColor: 'rgb(16, 185, 129)',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y',
                    borderWidth: 2.5,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                },
                {
                    label: 'Orders',
                    data: {{ chart_orders|safe }},
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1',
                    borderWidth: 2.5,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                }
            ]
        };
        
        new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2.5,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12,
                                weight: '500'
                            }
                        }
                    },
                    title: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(30, 41, 59, 0.95)',
                        padding: 12,
                        titleFont: {
                            size: 13,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 12
                        },
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 0) {
                                    return 'Revenue: ₹' + context.parsed.y.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                                } else {
                                    return 'Orders: ' + context.parsed.y;
                                }
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            color: '#64748b'
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Revenue (₹)',
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            color: '#10b981'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            color: '#64748b',
                            callback: function(value) {
                                return '₹' + value.toLocaleString('en-IN');
                            }
                        },
                        grid: {
                            color: 'rgba(226, 232, 240, 0.5)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Orders',
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            color: '#3b82f6'
                        },
                        ticks: {
                            font: {
                                size: 11
                            },
                            color: '#64748b'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }
});
</script>

<style>
  .card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
  }
  
  .table tbody tr:hover {
    background-color: #f8fafc;
    transition: background-color 0.2s ease;
  }
  
  .form-select:focus, .form-control:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 0.2rem rgba(59, 130, 246, 0.1);
  }
  
  .btn {
    transition: all 0.2s ease;
  }
  
  .btn:hover {
    transform: translateY(-1px);
  }
</style>

{% endblock %}
