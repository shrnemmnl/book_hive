{% extends "admin/admin_base.html" %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
{% endblock head %}

{% block heading %}
<div class="d-flex justify-content-between align-items-center">
    <h2 class="fw-semibold mb-0" style="font-size: 1.5rem; color: #1e293b;">Order Details #{{ order.order_id }}</h2>
    <a href="{% url 'admin_order' %}" class="btn btn-outline-secondary" style="font-size: 0.9rem; padding: 0.5rem 1rem; border-radius: 6px;"><i class="bi bi-arrow-left me-2"></i>Back to Orders</a>
</div>
{% endblock heading %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Messages -->
    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" style="font-size: 0.85rem; border-radius: 6px; background-color: #f1f5f9; color: #1e293b;">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Order Information Card -->
    <div class="card shadow-sm mb-4" style="border-radius: 10px; border: none;">
        <div class="card-header" style="border-radius: 10px 10px 0 0; background-color: #f8fafc;">
            <h5 class="mb-0 fw-medium" style="font-size: 1.1rem; color: #1e293b;">Order Information</h5>
        </div>
        <div class="card-body" style="padding: 1.5rem;">
            <div class="row g-3">
                <div class="col-md-3">
                    <p class="fw-medium mb-1" style="font-size: 0.9rem; color: #1e293b;">Order ID</p>
                    <p class="text-muted" style="font-size: 0.85rem;">{{ order.order_id }}</p>
                </div>
                <div class="col-md-3">
                    <p class="fw-medium mb-1" style="font-size: 0.9rem; color: #1e293b;">Order Date</p>
                    <p class="text-muted" style="font-size: 0.85rem;">{{ order.created_at|date:"d M Y, h:i A" }}</p>
                </div>
                <div class="col-md-3">
                    <p class="fw-medium mb-1" style="font-size: 0.9rem; color: #1e293b;">Payment Method</p>
                    <p class="text-muted" style="font-size: 0.85rem;">{{ order.payment_method|default:"Cash on Delivery" }}</p>
                </div>
                <div class="col-md-3">
                    <p class="fw-medium mb-1" style="font-size: 0.9rem; color: #1e293b;">Payment Status</p>
                    {% if order.is_paid %}
                    <p class="fw-medium mb-1 badge bg-success text-white" style="font-size: 0.9rem;">Paid</p>
                    {% else %}
                    <p class="fw-medium mb-1 badge bg-danger text-white" style="font-size: 0.9rem;">Not Paid</p>
                    {% endif %}
                    
                </div>
            </div>
        </div>
    </div>

    <!-- Customer Details Card -->
    <div class="card shadow-sm mb-4" style="border-radius: 10px; border: none;">
        <div class="card-header" style="border-radius: 10px 10px 0 0; background-color: #f8fafc;">
            <h5 class="mb-0 fw-medium" style="font-size: 1.1rem; color: #1e293b;">Customer Details</h5>
        </div>
        <div class="card-body" style="padding: 1.5rem;">
            <div class="row g-3">
                <div class="col-md-6">
                    <h6 class="fw-medium" style="font-size: 0.95rem; color: #1e293b;">Customer Information</h6>
                    <p class="mb-1 text-muted" style="font-size: 0.85rem;"><strong>Name:</strong>{{ order.user.first_name }} {{ order.user.last_name }}</p>
                    <p class="mb-1 text-muted" style="font-size: 0.85rem;"><strong>Email:</strong> {{ order.user.email }}</p>
                    <p class="mb-1 text-muted" style="font-size: 0.85rem;"><strong>Phone:</strong> {{ order.address.phone |default:"Not provided" }}</p>
                </div>
                <div class="col-md-6">
                    <h6 class="fw-medium" style="font-size: 0.95rem; color: #1e293b;">Shipping Address</h6>
                    <address class="text-muted" style="font-size: 0.85rem;">
                        {{ order.address.address_type }}<br>
                        {{ order.address.street }}<br>
                        
                        {{ order.address.city }}<br>
                        
                        {{ order.address.landmark }}, {{ order.address.state }} {{ order.address.postal_code }}<br>
                        
                    </address>
                </div>
            </div>
        </div>
    </div>

<!-- Order Items Card -->
<div class="card shadow-sm mb-4" style="border-radius: 10px; border: none;">
    <div class="card-header" style="border-radius: 10px 10px 0 0; background-color: #f8fafc;">
        <h5 class="mb-0 fw-medium" style="font-size: 1.1rem; color: #1e293b;">Order Items</h5>
    </div>
    <div class="card-body" style="padding: 1.5rem;">
        <!-- Display Current Order Status -->
        <div class="mb-3">
            <p class="mb-2" style="font-size: 0.9rem; color: #1e293b;">
                Current Status: 
                <span class="{% if order.status == 'pending' %}badge bg-warning text-dark{% elif order.status == 'shipped' %}badge bg-info text-dark{% elif order.status == 'out_for_delivery' %}badge bg-primary{% elif order.status == 'delivered' %}badge bg-success{% elif order.status == 'cancelled' %}badge bg-danger{% endif %}" style="font-size: 0.85rem;">
                    {{ order.status|title }}
                </span>
            </p>
            {% if order.status == 'request to cancel' or order.status == 'cancelled' %}
            <p class="mb-2" style="font-size: 0.9rem; color: #1e293b;">
                Cancel Reason: 
                <span class="text-dark" style="font-size: 0.85rem;">
                    {{ order.cancel_reason|title|default:"No reason provided" }}
                </span>
            </p>
            {% endif %}
            <!-- Order Status Form -->
            <form action="{% url 'admin_order_details' order.id %}" method="POST" class="d-flex align-items-center">
                {% csrf_token %}
                <label for="order_status" class="me-2" style="font-size: 0.9rem; color: #1e293b;">Update Status:</label>
                <select name="status" id="order_status" class="form-select form-select-sm me-2" style="font-size: 0.85rem; padding: 0.4rem; border-radius: 6px; max-width: 140px;">
                    <option value="pending" {% if order.status == "pending" %}selected{% endif %}>Pending</option>
                    <option value="shipped" {% if order.status == "shipped" %}selected{% endif %}>Shipped</option>
                    <!-- <option value="out_for_delivery" {% if order.status == "out_for_delivery" %}selected{% endif %}>Out for Delivery</option> -->
                    <option value="delivered" {% if order.status == "delivered" %}selected{% endif %}>Delivered</option>
                    <option value="cancelled" {% if order.status == "cancelled" %}selected{% endif %}>Cancelled</option>
                </select>
                <button type="submit" class="btn btn-sm btn-outline-success" style="font-size: 0.85rem; padding: 0.4rem 0.8rem; border-radius: 6px;">Update</button>
            </form>
        </div>
        <!-- Order Items Table -->
        <div class="table-responsive">
            <table class="table table-hover align-middle" style="font-size: 0.9rem;">
                <thead>
                    <tr>
                        <th scope="col" style="color: #1e293b; font-weight: 500;">#</th>
                        <th scope="col" style="color: #1e293b; font-weight: 500;">Product</th>
                        <th scope="col" style="color: #1e293b; font-weight: 500;">Image</th>
                        <th scope="col" style="color: #1e293b; font-weight: 500;">Quantity</th>
                        <th scope="col" style="color: #1e293b; font-weight: 500;">Price</th>
                        <th scope="col" style="color: #1e293b; font-weight: 500;">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order.order_items.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <p class="mb-0 fw-medium" style="color: #1e293b; font-size: 0.9rem;">{{ item.product_variant.product.book_title }}</p>
                            <small class="text-muted" style="font-size: 0.8rem;">{{ item.product_variant.product.author }}</small>
                        </td>
                        <td>
                            <img src="{{ item.product_variant.product.image.url }}" alt="Book Cover" class="img-thumbnail" style="max-height: 50px; border-radius: 6px; border: none;">
                        </td>
                        <td>{{ item.quantity }}</td>
                        <td>₹{{ item.product_variant.price|floatformat:2 }}</td>
                        <td>₹{{ item.total_amount|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

    <!-- Order Summary Card -->
    <div class="card shadow-sm mb-4" style="border-radius: 10px; border: none;">
        <div class="card-header" style="border-radius: 10px 10px 0 0; background-color: #f8fafc;">
            <h5 class="mb-0 fw-medium" style="font-size: 1.1rem; color: #1e293b;">Order Summary</h5>
        </div>
        <div class="card-body" style="padding: 1.5rem;">
            <div class="row justify-content-end">
                <div class="col-md-5">
                    <table class="table table-sm" style="font-size: 0.9rem;">
                        <tbody>
                            <tr>
                                <td class="fw-medium" style="color: #1e293b;">Subtotal</td>
                                <td class="text-end text-muted">₹{{ order.net_amount|floatformat:2 }}</td>
                            </tr>
                            {% if order.discount_amount %}
                            <tr>
                                <td class="fw-medium" style="color: #1e293b;">Discount</td>
                                <td class="text-end text-muted">-₹{{ order.discount_amount|floatformat:2 }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td class="fw-medium" style="color: #1e293b;">Shipping</td>
                                <td class="text-end text-muted">₹{{ order.shipping_cost|default:"0.00" }}</td>
                            </tr>
                            <tr>
                                <td class="fw-medium" style="color: #1e293b;">Tax</td>
                                <td class="text-end text-muted">₹{{ order.tax_amount|default:"0.00" }}</td>
                            </tr>
                            <tr class="table-active">
                                <td class="fw-semibold" style="color: #1e293b; font-size: 1rem;">Grand Total</td>
                                <td class="text-end fw-semibold" style="color: #1e293b; font-size: 1rem;">₹{{ order.net_amount|floatformat:2 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Order History Card -->
    <div class="card shadow-sm mb-4" style="border-radius: 10px; border: none;">
        <div class="card-header" style="border-radius: 10px 10px 0 0; background-color: #f8fafc;">
            <h5 class="mb-0 fw-medium" style="font-size: 1.1rem; color: #1e293b;">Order History</h5>
        </div>
        <div class="card-body" style="padding: 1.5rem;">
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center" style="border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                    <div>
                        <p class="mb-0 fw-medium" style="color: #1e293b;">Order Created</p>
                        <small class="text-muted" style="font-size: 0.8rem;">Initial order placed</small>
                    </div>
                    <span class="text-muted" style="font-size: 0.85rem;">{{ order.created_at|date:"d M Y, h:i A" }}</span>
                </li>
                
                
                    {% if order.status == "shipped" %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" style="border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                        <div>
                            <p class="mb-0 fw-medium" style="color: #1e293b;">Item Shipped</p>
                            <small class="text-muted" style="font-size: 0.8rem;">{{ item.product_variant.product.book_title }}</small>
                        </div>
                        <span class="text-muted" style="font-size: 0.85rem;">{{ order.updated_at|default:""|date:"d M Y, h:i A" }}</span>
                    </li>
                    {% endif %}
                    {% if order.status == "delivered" %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" style="border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                        <div>
                            <p class="mb-0 fw-medium" style="color: #1e293b;">Item Delivered</p>
                            <small class="text-muted" style="font-size: 0.8rem;">{{ item.product_variant.product.book_title }}</small>
                        </div>
                        <span class="text-muted" style="font-size: 0.85rem;">{{ order.updated_at|default:""|date:"d M Y, h:i A" }}</span>
                    </li>
                    {% endif %}
                    {% if order.status == "cancelled" %}
                    <li class="list-group-item d-flex justify-content-between align-items-center" style="border-bottom: 1px solid #e2e8f0; font-size: 0.9rem;">
                        <div>
                            <p class="mb-0 fw-medium" style="color: #1e293b;">Item Cancelled</p>
                            <small class="text-muted" style="font-size: 0.8rem;">{{ item.product.book_title }}</small>
                        </div>
                        <span class="text-muted" style="font-size: 0.85rem;">{{ order.updated_at|default:""|date:"d M Y, h:i A" }}</span>
                    </li>
                    {% endif %}
                
            </ul>
        </div>
    </div>
</div>

<style>
    .card {
        background-color: #ffffff;
        border: none;
        transition: box-shadow 0.2s ease;
    }
    .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .card-header {
        background-color: #f8fafc;
        border-bottom: none;
    }
    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: #2563eb;
        box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.1);
    }
    .btn-outline-secondary, .btn-outline-success {
        border: 1px solid #e2e8f0;
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .btn-outline-secondary:hover {
        background-color: #64748b;
        color: #ffffff;
        border-color: #64748b;
    }
    .btn-outline-success:hover {
        background-color: #16a34a;
        color: #ffffff;
        border-color: #16a34a;
    }
    .table {
        font-size: 0.9rem;
    }
    .table th {
        color: #1e293b;
        font-weight: 500;
    }
    .table td {
        vertical-align: middle;
    }
    .badge {
        font-size: 0.8rem;
        padding: 0.4em 0.7em;
    }
    .list-group-item {
        border: none;
        border-bottom: 1px solid #e2e8f0;
    }
    .alert {
        background-color: #f1f5f9;
        color: #1e293b;
    }
</style>
{% endblock %}